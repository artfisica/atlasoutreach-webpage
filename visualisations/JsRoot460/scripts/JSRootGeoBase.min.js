(function(a){if(typeof define==="function"&&define.amd){define(["JSRootCore","threejs","ThreeCSG"],a)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootGeoBase.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRootGeoBase.js")}a(JSROOT)}}(function(a){a.GEO={GradPerSegm:6,CompressComp:true};a.GEO.BITS={kVisOverride:a.BIT(0),kVisNone:a.BIT(1),kVisThis:a.BIT(2),kVisDaughters:a.BIT(3),kVisOneLevel:a.BIT(4),kVisStreamed:a.BIT(5),kVisTouched:a.BIT(6),kVisOnScreen:a.BIT(7),kVisContainers:a.BIT(12),kVisOnly:a.BIT(13),kVisBranch:a.BIT(14),kVisRaytrace:a.BIT(15)};a.GEO.TestBit=function(c,d){var b=c.fGeoAtt;return b===undefined?false:((b&d)!==0)};a.GEO.SetBit=function(b,d,c){if(b.fGeoAtt===undefined){return}b.fGeoAtt=c?(b.fGeoAtt|d):(b.fGeoAtt&~d)};a.GEO.ToggleBit=function(b,c){if(b.fGeoAtt!==undefined){b.fGeoAtt=b.fGeoAtt^(c&16777215)}};a.GEO.warn=function(b){if(a.GEO._warn_msgs===undefined){a.GEO._warn_msgs={}}if(a.GEO._warn_msgs[b]!==undefined){return}a.GEO._warn_msgs[b]=true;console.warn(b)};a.GEO.NodeKind=function(b){if((b===undefined)||(b===null)||(typeof b!=="object")){return -1}return("fShape" in b)&&("fTrans" in b)?1:0};a.GEO.getNodeProperties=function(g,f,e){if(g===1){var b={name:f.fName,nname:f.fName,shape:f.fShape,material:null,chlds:null};if(f.fElements!==null){b.chlds=f.fElements.arr}if(e){var j=false,i=1;if(f.fRGBA[3]<1){j=true;i=f.fRGBA[3]}b.fillcolor=new THREE.Color(f.fRGBA[0],f.fRGBA[1],f.fRGBA[2]);b.material=new THREE.MeshLambertMaterial({transparent:j,opacity:i,wireframe:false,color:b.fillcolor,side:THREE.FrontSide,vertexColors:THREE.NoColors,overdraw:0});b.material.alwaysTransparent=j;b.material.inherentOpacity=i}return b}var h=f.fVolume;var b={name:h.fName,nname:f.fName,volume:f.fVolume,shape:h.fShape,material:null,chlds:null};if(f.fVolume.fNodes!==null){b.chlds=f.fVolume.fNodes.arr}if(e){var j=false,i=1;if((h.fFillColor>1)&&(h.fLineColor==1)){b.fillcolor=a.Painter.root_colors[h.fFillColor]}else{if(h.fLineColor>=0){b.fillcolor=a.Painter.root_colors[h.fLineColor]}}if(h.fMedium&&h.fMedium.fMaterial){var c=h.fMedium.fMaterial.fFillStyle;var d=(c<3000||c>3100)?0:c-3000;if(d>0){j=true;i=(100-d)/100}if(b.fillcolor===undefined){b.fillcolor=a.Painter.root_colors[h.fMedium.fMaterial.fFillColor]}}if(b.fillcolor===undefined){b.fillcolor="lightgrey"}b.material=new THREE.MeshLambertMaterial({transparent:j,opacity:i,wireframe:false,color:b.fillcolor,side:THREE.FrontSide,vertexColors:THREE.NoColors,overdraw:0});b.material.alwaysTransparent=j;b.material.inherentOpacity=i}return b};a.GEO.GeometryCreator=function(b){this.nfaces=b;this.indx=0;this.pos=new Float32Array(b*9);this.norm=new Float32Array(b*9);return this};a.GEO.GeometryCreator.prototype.AddFace3=function(d,l,g,c,k,f,b,i,e){var h=this.indx,j=this.pos;j[h]=d;j[h+1]=l;j[h+2]=g;j[h+3]=c;j[h+4]=k;j[h+5]=f;j[h+6]=b;j[h+7]=i;j[h+8]=e;this.last4=false;this.indx=h+9};a.GEO.GeometryCreator.prototype.StartPolygon=function(){};a.GEO.GeometryCreator.prototype.StopPolygon=function(){};a.GEO.GeometryCreator.prototype.AddFace4=function(d,o,h,c,n,g,b,l,f,p,j,e,k){var i=this.indx,m=this.pos;if(k!==1){m[i]=d;m[i+1]=o;m[i+2]=h;m[i+3]=c;m[i+4]=n;m[i+5]=g;m[i+6]=b;m[i+7]=l;m[i+8]=f;i+=9}if(k!==2){m[i]=d;m[i+1]=o;m[i+2]=h;m[i+3]=b;m[i+4]=l;m[i+5]=f;m[i+6]=p;m[i+7]=j;m[i+8]=e;i+=9}this.last4=(i!==this.indx+9);this.indx=i};a.GEO.GeometryCreator.prototype.SetNormal4=function(c,m,g,p,k,f,o,j,e,n,i,d,l){if(this.last4&&l){return console.error("missmatch between AddFace4 and SetNormal4 calls")}var h=this.indx-(this.last4?18:9),b=this.norm;if(l!==1){b[h]=c;b[h+1]=m;b[h+2]=g;b[h+3]=p;b[h+4]=k;b[h+5]=f;b[h+6]=o;b[h+7]=j;b[h+8]=e;h+=9}if(l!==2){b[h]=c;b[h+1]=m;b[h+2]=g;b[h+3]=o;b[h+4]=j;b[h+5]=e;b[h+6]=n;b[h+7]=i;b[h+8]=d}};a.GEO.GeometryCreator.prototype.RecalcZ=function(d){var e=this.pos,c=this.indx,b=c-(this.last4?18:9);while(b<c){e[b+2]=d(e[b],e[b+1],e[b+2]);b+=3}};a.GEO.GetNormal=function(e,n,k,c,m,j,b,l,i){var g=new THREE.Vector3(e,n,k),f=new THREE.Vector3(c,m,j),d=new THREE.Vector3(b,l,i),h=new THREE.Vector3(),o=new THREE.Vector3();h.subVectors(d,f);o.subVectors(g,f);h.cross(o);return h};a.GEO.GeometryCreator.prototype.CalcNormal=function(){var c=this.indx,b=this.norm;if(!this.cb){this.pA=new THREE.Vector3();this.pB=new THREE.Vector3();this.pC=new THREE.Vector3();this.cb=new THREE.Vector3();this.ab=new THREE.Vector3()}this.pA.fromArray(this.pos,this.indx-9);this.pB.fromArray(this.pos,this.indx-6);this.pC.fromArray(this.pos,this.indx-3);this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.SetNormal(this.cb.x,this.cb.y,this.cb.z)};a.GEO.GeometryCreator.prototype.SetNormal=function(b,f,e){var d=this.indx-9,c=this.norm;c[d]=c[d+3]=c[d+6]=b;c[d+1]=c[d+4]=c[d+7]=f;c[d+2]=c[d+5]=c[d+8]=e;if(this.last4){d-=9;c[d]=c[d+3]=c[d+6]=b;c[d+1]=c[d+4]=c[d+7]=f;c[d+2]=c[d+5]=c[d+8]=e}};a.GEO.GeometryCreator.prototype.SetNormal_12_34=function(c,e,g,d,h,j,i){if(i===undefined){i=0}var f=this.indx-((i>0)?9:18),b=this.norm;if(i!==1){b[f]=c;b[f+1]=e;b[f+2]=g;b[f+3]=c;b[f+4]=e;b[f+5]=g;b[f+6]=d;b[f+7]=h;b[f+8]=j;f+=9}if(i!==2){b[f]=c;b[f+1]=e;b[f+2]=g;b[f+3]=d;b[f+4]=h;b[f+5]=j;b[f+6]=d;b[f+7]=h;b[f+8]=j;f+=9}};a.GEO.GeometryCreator.prototype.Create=function(){if(this.nfaces!==this.indx/9){console.error("Mismatch with created "+this.nfaces+" and filled "+this.indx/9+" number of faces")}var b=new THREE.BufferGeometry();b.addAttribute("position",new THREE.BufferAttribute(this.pos,3));b.addAttribute("normal",new THREE.BufferAttribute(this.norm,3));return b};a.GEO.PolygonsCreator=function(){this.polygons=[]};a.GEO.PolygonsCreator.prototype.StartPolygon=function(b){this.multi=1;this.mnormal=b};a.GEO.PolygonsCreator.prototype.StopPolygon=function(){if(!this.multi){return}this.multi=0;console.error("Polygon should be already closed at this moment")};a.GEO.PolygonsCreator.prototype.AddFace3=function(d,j,g,c,i,f,b,h,e){this.AddFace4(d,j,g,c,i,f,b,h,e,b,h,e,2)};a.GEO.PolygonsCreator.prototype.AddFace4=function(r,e,m,q,d,j,p,c,i,o,b,h,l){if(l===undefined){l=0}this.v1=new ThreeBSP.Vertex(r,e,m,0,0,0);this.v2=(l===1)?null:new ThreeBSP.Vertex(q,d,j,0,0,0);this.v3=new ThreeBSP.Vertex(p,c,i,0,0,0);this.v4=(l===2)?null:new ThreeBSP.Vertex(o,b,h,0,0,0);this.reduce=l;if(this.multi){if(l!==2){console.error("polygon not supported for not-reduced faces")}var k;if(this.multi++===1){k=new ThreeBSP.Polygon;k.vertices.push(this.mnormal?this.v2:this.v3);this.polygons.push(k)}else{k=this.polygons[this.polygons.length-1];var g=this.mnormal?k.vertices[k.vertices.length-1]:k.vertices[0],s=this.mnormal?this.v2:this.v3;if(s.diff(g)>1e-12){console.error("vertex missmatch when building polygon")}}var f=this.mnormal?k.vertices[0]:k.vertices[k.vertices.length-1],n=this.mnormal?this.v3:this.v2;if(n.diff(f)<1e-12){this.multi=0}else{if(this.mnormal){k.vertices.push(this.v3)}else{k.vertices.unshift(this.v2)}}return}var k=new ThreeBSP.Polygon;switch(l){case 0:k.vertices.push(this.v1,this.v2,this.v3,this.v4);break;case 1:k.vertices.push(this.v1,this.v3,this.v4);break;case 2:k.vertices.push(this.v1,this.v2,this.v3);break}this.polygons.push(k)};a.GEO.PolygonsCreator.prototype.SetNormal4=function(b,k,f,n,i,e,m,h,d,l,g,c,j){this.v1.setnormal(b,k,f);if(this.v2){this.v2.setnormal(n,i,e)}this.v3.setnormal(m,h,d);if(this.v4){this.v4.setnormal(l,g,c)}};a.GEO.PolygonsCreator.prototype.SetNormal_12_34=function(e,c,h,g,d,b,f){this.v1.setnormal(e,c,h);if(this.v2){this.v2.setnormal(e,c,h)}this.v3.setnormal(g,d,b);if(this.v4){this.v4.setnormal(g,d,b)}};a.GEO.PolygonsCreator.prototype.CalcNormal=function(){if(!this.cb){this.pA=new THREE.Vector3();this.pB=new THREE.Vector3();this.pC=new THREE.Vector3();this.cb=new THREE.Vector3();this.ab=new THREE.Vector3()}this.pA.set(this.v1.x,this.v1.y,this.v1.z);if(this.reduce!==1){this.pB.set(this.v2.x,this.v2.y,this.v2.z);this.pC.set(this.v3.x,this.v3.y,this.v3.z)}else{this.pB.set(this.v3.x,this.v3.y,this.v3.z);this.pC.set(this.v4.x,this.v4.y,this.v4.z)}this.cb.subVectors(this.pC,this.pB);this.ab.subVectors(this.pA,this.pB);this.cb.cross(this.ab);this.SetNormal(this.cb.x,this.cb.y,this.cb.z)};a.GEO.PolygonsCreator.prototype.SetNormal=function(b,d,c){this.v1.setnormal(b,d,c);if(this.v2){this.v2.setnormal(b,d,c)}this.v3.setnormal(b,d,c);if(this.v4){this.v4.setnormal(b,d,c)}};a.GEO.PolygonsCreator.prototype.RecalcZ=function(b){this.v1.z=b(this.v1.x,this.v1.y,this.v1.z);if(this.v2){this.v2.z=b(this.v2.x,this.v2.y,this.v2.z)}this.v3.z=b(this.v3.x,this.v3.y,this.v3.z);if(this.v4){this.v4.z=b(this.v4.x,this.v4.y,this.v4.z)}};a.GEO.PolygonsCreator.prototype.Create=function(){return{polygons:this.polygons}};a.GEO.createCube=function(c){var e=new THREE.Geometry();e.vertices.push(new THREE.Vector3(c.fDX,c.fDY,c.fDZ));e.vertices.push(new THREE.Vector3(c.fDX,c.fDY,-c.fDZ));e.vertices.push(new THREE.Vector3(c.fDX,-c.fDY,c.fDZ));e.vertices.push(new THREE.Vector3(c.fDX,-c.fDY,-c.fDZ));e.vertices.push(new THREE.Vector3(-c.fDX,c.fDY,-c.fDZ));e.vertices.push(new THREE.Vector3(-c.fDX,c.fDY,c.fDZ));e.vertices.push(new THREE.Vector3(-c.fDX,-c.fDY,-c.fDZ));e.vertices.push(new THREE.Vector3(-c.fDX,-c.fDY,c.fDZ));var h=[0,2,1,2,3,1,4,6,5,6,7,5,4,5,1,5,0,1,7,6,2,6,3,2,5,7,0,7,2,0,1,3,4,3,6,4];var f=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1];var b=new THREE.Color();var d=null;for(var i=0;i<h.length;i+=3){if(i%6===0){d=new THREE.Vector3(f[i/2],f[i/2+1],f[i/2+2])}var g=new THREE.Face3(h[i],h[i+1],h[i+2],d,b,0);e.faces.push(g)}return e};a.GEO.createCubeBuffer=function(e,g){if(g<0){return 12}var d=e.fDX,c=e.fDY,b=e.fDZ;var f=g?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(12);f.AddFace4(d,c,b,d,-c,b,d,-c,-b,d,c,-b);f.SetNormal(1,0,0);f.AddFace4(-d,c,-b,-d,-c,-b,-d,-c,b,-d,c,b);f.SetNormal(-1,0,0);f.AddFace4(-d,c,-b,-d,c,b,d,c,b,d,c,-b);f.SetNormal(0,1,0);f.AddFace4(-d,-c,b,-d,-c,-b,d,-c,-b,d,-c,b);f.SetNormal(0,-1,0);f.AddFace4(-d,c,b,-d,-c,b,d,-c,b,d,c,b);f.SetNormal(0,0,1);f.AddFace4(d,c,-b,d,-c,-b,-d,-c,-b,-d,c,-b);f.SetNormal(0,0,-1);return f.Create()};a.GEO.createPara=function(g){var c=g.fTxy,b=g.fTxz,k=g.fTyz;var j=[-g.fZ*b-c*g.fY-g.fX,-g.fY-g.fZ*k,-g.fZ,-g.fZ*b+c*g.fY-g.fX,g.fY-g.fZ*k,-g.fZ,-g.fZ*b+c*g.fY+g.fX,g.fY-g.fZ*k,-g.fZ,-g.fZ*b-c*g.fY+g.fX,-g.fY-g.fZ*k,-g.fZ,g.fZ*b-c*g.fY-g.fX,-g.fY+g.fZ*k,g.fZ,g.fZ*b+c*g.fY-g.fX,g.fY+g.fZ*k,g.fZ,g.fZ*b+c*g.fY+g.fX,g.fY+g.fZ*k,g.fZ,g.fZ*b-c*g.fY+g.fX,-g.fY+g.fZ*k,g.fZ];var d=[4,6,5,4,7,6,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];var h=new THREE.Geometry();for(var f=0;f<j.length;f+=3){h.vertices.push(new THREE.Vector3(j[f],j[f+1],j[f+2]))}var e=new THREE.Color();for(var f=0;f<d.length;f+=3){h.faces.push(new THREE.Face3(d[f],d[f+1],d[f+2],null,e,0))}h.computeFaceNormals();return h};a.GEO.create8edgesBuffer=function(j,i){var g=[4,7,6,5,0,3,7,4,4,5,1,0,6,2,1,5,7,3,2,6,1,2,3,0];var d=(i>0)?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(12);for(var c=0;c<g.length;c+=4){var h=g[c]*3,f=g[c+1]*3,e=g[c+2]*3,b=g[c+3]*3;d.AddFace4(j[h],j[h+1],j[h+2],j[f],j[f+1],j[f+2],j[e],j[e+1],j[e+2],j[b],j[b+1],j[b+2]);if(c===0){d.SetNormal(0,0,1)}else{if(c===20){d.SetNormal(0,0,-1)}else{d.CalcNormal()}}}return d.Create()};a.GEO.createParaBuffer=function(c,g){if(g<0){return 12}var e=c.fTxy,d=c.fTxz,f=c.fTyz;var b=[-c.fZ*d-e*c.fY-c.fX,-c.fY-c.fZ*f,-c.fZ,-c.fZ*d+e*c.fY-c.fX,c.fY-c.fZ*f,-c.fZ,-c.fZ*d+e*c.fY+c.fX,c.fY-c.fZ*f,-c.fZ,-c.fZ*d-e*c.fY+c.fX,-c.fY-c.fZ*f,-c.fZ,c.fZ*d-e*c.fY-c.fX,-c.fY+c.fZ*f,c.fZ,c.fZ*d+e*c.fY-c.fX,c.fY+c.fZ*f,c.fZ,c.fZ*d+e*c.fY+c.fX,c.fY+c.fZ*f,c.fZ,c.fZ*d-e*c.fY+c.fX,-c.fY+c.fZ*f,c.fZ];return a.GEO.create8edgesBuffer(b,g)};a.GEO.createTrapezoid=function(d){var g,f;if(d._typename=="TGeoTrd1"){g=f=d.fDY}else{g=d.fDy1;f=d.fDy2}var b=[-d.fDx1,g,-d.fDZ,d.fDx1,g,-d.fDZ,d.fDx1,-g,-d.fDZ,-d.fDx1,-g,-d.fDZ,-d.fDx2,f,d.fDZ,d.fDx2,f,d.fDZ,d.fDx2,-f,d.fDZ,-d.fDx2,-f,d.fDZ];var j=[4,6,5,4,7,6,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];var h=new THREE.Geometry();for(var e=0;e<24;e+=3){h.vertices.push(new THREE.Vector3(b[e],b[e+1],b[e+2]))}var c=new THREE.Color();for(var e=0;e<36;e+=3){h.faces.push(new THREE.Face3(j[e],j[e+1],j[e+2],null,c,0))}h.computeFaceNormals();return h};a.GEO.createTrapezoidBuffer=function(c,f){if(f<0){return 12}var e,d;if(c._typename=="TGeoTrd1"){e=d=c.fDY}else{e=c.fDy1;d=c.fDy2}var b=[-c.fDx1,e,-c.fDZ,c.fDx1,e,-c.fDZ,c.fDx1,-e,-c.fDZ,-c.fDx1,-e,-c.fDZ,-c.fDx2,d,c.fDZ,c.fDx2,d,c.fDZ,c.fDx2,-d,c.fDZ,-c.fDx2,-d,c.fDZ];return a.GEO.create8edgesBuffer(b,f)};a.GEO.createArb8=function(m){var l=[m.fXY[0][0],m.fXY[0][1],-m.fDZ,m.fXY[1][0],m.fXY[1][1],-m.fDZ,m.fXY[2][0],m.fXY[2][1],-m.fDZ,m.fXY[3][0],m.fXY[3][1],-m.fDZ,m.fXY[4][0],m.fXY[4][1],m.fDZ,m.fXY[5][0],m.fXY[5][1],m.fDZ,m.fXY[6][0],m.fXY[6][1],m.fDZ,m.fXY[7][0],m.fXY[7][1],m.fDZ];var g=[4,6,5,4,7,6,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];for(var e=3;e<l.length;e+=3){if((l[e-3]===l[e])&&(l[e-2]===l[e+1])&&(l[e-1]===l[e+2])){for(var h=0;h<g.length;++h){if(g[h]===e/3){g[h]=e/3-1}}}}var d=[];var p=[0,0,0,0,0,0,0,0];for(var h=0;h<g.length;h+=3){var v=g[h]*100+g[h+1]*10+g[h+2],u=g[h+1]*100+g[h+2]*10+g[h],t=g[h+2]*100+g[h]*10+g[h+1];if((g[h]==g[h+1])||(g[h]==g[h+2])||(g[h+1]==g[h+2])||(d.indexOf(v)>=0)||(d.indexOf(u)>=0)||(d.indexOf(t)>=0)){g[h]=g[h+1]=g[h+2]=-1}else{d.push(v,u,t);p[g[h]]++;p[g[h+1]]++;p[g[h+2]]++}}var r=new THREE.Geometry();for(var j=0;j<8;++j){if(p[j]>0){p[j]=r.vertices.length;r.vertices.push(new THREE.Vector3(l[j*3],l[j*3+1],l[j*3+2]))}else{p[j]=-1}}var f=new THREE.Color();for(var j=0;j<36;j+=3){if(g[j]<0){continue}var s=p[g[j]],q=p[g[j+1]],o=p[g[j+2]];r.faces.push(new THREE.Face3(s,q,o,null,f,0))}r.computeFaceNormals();return r};a.GEO.createArb8Buffer=function(e,j){if(j<0){return 12}var i=[e.fXY[0][0],e.fXY[0][1],-e.fDZ,e.fXY[1][0],e.fXY[1][1],-e.fDZ,e.fXY[2][0],e.fXY[2][1],-e.fDZ,e.fXY[3][0],e.fXY[3][1],-e.fDZ,e.fXY[4][0],e.fXY[4][1],e.fDZ,e.fXY[5][0],e.fXY[5][1],e.fDZ,e.fXY[6][0],e.fXY[6][1],e.fDZ,e.fXY[7][0],e.fXY[7][1],e.fDZ];var f=[4,7,6,6,5,4,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];for(var g=0;g<i.length;g+=i.length/2){for(var m=g;m<g+i.length/2-3;m+=3){for(var l=m+3;l<g+i.length/2;l+=3){if((i[m]===i[l])&&(i[m+1]===i[l+1])&&(i[m+2]===i[l+2])){for(var y=0;y<f.length;++y){if(f[y]===l/3){f[y]=m/3}}}}}}var A=[];var z=0;for(var y=0;y<f.length;y+=3){var d=f[y]*100+f[y+1]*10+f[y+2],c=f[y+1]*100+f[y+2]*10+f[y],b=f[y+2]*100+f[y]*10+f[y+1];if((f[y]==f[y+1])||(f[y]==f[y+2])||(f[y+1]==f[y+2])||(A.indexOf(d)>=0)||(A.indexOf(c)>=0)||(A.indexOf(b)>=0)){f[y]=f[y+1]=f[y+2]=-1}else{A.push(d,c,b);z++}}var o=j?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(z);for(var v=0;v<f.length;v+=6){var x=f[v]*3,w=f[v+1]*3,u=f[v+2]*3,t=f[v+3]*3,s=f[v+4]*3,r=f[v+5]*3,h=null;if((x>=0)&&(t>=0)&&j){if(v===0){h=new THREE.Vector3(0,0,1)}else{if(v===30){h=new THREE.Vector3(0,0,-1)}else{var q=a.GEO.GetNormal(i[x],i[x+1],i[x+2],i[w],i[w+1],i[w+2],i[u],i[u+1],i[u+2]);q.normalize();var p=a.GEO.GetNormal(i[t],i[t+1],i[t+2],i[s],i[s+1],i[s+2],i[r],i[r+1],i[r+2]);p.normalize();if(q.distanceToSquared(p)<1e-12){h=q}}}}if(h!==null){o.AddFace4(i[x],i[x+1],i[x+2],i[w],i[w+1],i[w+2],i[u],i[u+1],i[u+2],i[s],i[s+1],i[s+2]);o.SetNormal(h.x,h.y,h.z)}else{if(x>=0){o.AddFace3(i[x],i[x+1],i[x+2],i[w],i[w+1],i[w+2],i[u],i[u+1],i[u+2]);o.CalcNormal()}if(t>=0){o.AddFace3(i[t],i[t+1],i[t+2],i[s],i[s+1],i[s+2],i[r],i[r+1],i[r+2]);o.CalcNormal()}}}return o.Create()};a.GEO.createSphere=function(d,m){var y=d.fRmax,l=d.fRmin,r=d.fPhi1+180,u=d.fPhi2-d.fPhi1,f=d.fTheta1,s=d.fTheta2-d.fTheta1,e=d.fNseg,q=d.fNz;var b=(l<=0);while(r>=360){r-=360}if(m>0){var c=(b?2:4)*e*q/m;if(c>1){e=Math.round(e/Math.sqrt(c));q=Math.round(q/Math.sqrt(c))}}var h=new THREE.SphereGeometry(y,e,q,r*Math.PI/180,u*Math.PI/180,f*Math.PI/180,s*Math.PI/180);h.applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI/2));var g=new THREE.Geometry();var A=new THREE.Color();for(var t=0;t<h.vertices.length;++t){g.vertices.push(h.vertices[t])}for(var t=0;t<h.faces.length;++t){var o=h.faces[t];g.faces.push(new THREE.Face3(o.a,o.b,o.c,null,A,0))}var D=g.vertices.length;if(b){if((s===180)&&(u===360)){g.computeFaceNormals();return g}g.vertices.push(new THREE.Vector3(0,0,0))}else{var z=l/y;for(var t=0;t<h.vertices.length;++t){var p=h.vertices[t];g.vertices.push(new THREE.Vector3(z*p.x,z*p.y,z*p.z))}for(var t=0;t<h.faces.length;++t){var o=h.faces[t];g.faces.push(new THREE.Face3(D+o.b,D+o.a,D+o.c,null,A,0))}}if(s!==180){for(var C=0;C<e;++C){if(b){g.faces.push(new THREE.Face3(C+0,C+1,D,null,A,0))}else{g.faces.push(new THREE.Face3(C+0,C+1,C+D,null,A,0));g.faces.push(new THREE.Face3(C+1,C+D+1,C+D,null,A,0))}}var E=h.vertices.length-e-1;for(var C=E;C<E+e;++C){if(b){g.faces.push(new THREE.Face3(C+0,C+1,D,null,A,0))}else{g.faces.push(new THREE.Face3(C+1,C+0,C+D,null,A,0));g.faces.push(new THREE.Face3(C+D+1,C+1,C+D,null,A,0))}}}if(u!==360){for(var B=0;B<q;B++){var x=B*(e+1);var w=(B+1)*(e+1);if(b){g.faces.push(new THREE.Face3(x,w,D,null,A,0))}else{g.faces.push(new THREE.Face3(w,x,x+D,null,A,0));g.faces.push(new THREE.Face3(w+D,w,x+D,null,A,0))}}for(var B=0;B<q;B++){var x=(B+1)*(e+1)-1;var w=(B+2)*(e+1)-1;if(b){g.faces.push(new THREE.Face3(x,w,D,null,A,0))}else{g.faces.push(new THREE.Face3(x,w,x+D,null,A,0));g.faces.push(new THREE.Face3(w,w+D,x+D,null,A,0))}}}g.computeFaceNormals();return g};a.GEO.createSphereBuffer=function(j,t){var B=[j.fRmax,j.fRmin],p=j.fPhi1,N=j.fPhi2-j.fPhi1,J=j.fTheta1,o=j.fTheta2-j.fTheta1,z=j.fNseg,L=j.fNz;var E=(B[1]<=0);if(t>0){var d=(E?2:4)*z*L/t;if(d>1){z=Math.max(4,Math.floor(z/Math.sqrt(d)));L=Math.max(4,Math.floor(L/Math.sqrt(d)))}}var q=z*L*2,y=z*2,f=z*2,w=N===360?0:L*(E?2:4),D=1e-10;if(E){f=y=z}if(t<0){return q*(E?1:2)+y+f+w}var M=new Float32Array(z+1),c=new Float32Array(z+1),K=new Float32Array(L+1),b=new Float32Array(L+1);for(var G=0;G<=L;++G){var i=(J+o/L*G)*Math.PI/180;K[G]=Math.sin(i);b[G]=Math.cos(i)}for(var G=0;G<=z;++G){var O=(p+N/z*G)*Math.PI/180;M[G]=Math.sin(O);c[G]=Math.cos(O)}if(Math.abs(K[0])<=D){q-=z;y=0}if(Math.abs(K[L])<=D){q-=z;f=0}var m=q*(E?1:2)+y+f+w;var l=t?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(m);for(var g=0;g<2;++g){if((g===1)&&E){break}var C=B[g],A=(g===0)?1:-1,H=1-g,F=1-H;for(var I=0;I<L;++I){var v=I+H,u=I+F;var h=0;if(Math.abs(K[v])<=D){h=1}else{if(Math.abs(K[u])<=D){h=2}}for(var G=0;G<z;++G){l.AddFace4(C*K[v]*c[G],C*K[v]*M[G],C*b[v],C*K[v]*c[G+1],C*K[v]*M[G+1],C*b[v],C*K[u]*c[G+1],C*K[u]*M[G+1],C*b[u],C*K[u]*c[G],C*K[u]*M[G],C*b[u],h);l.SetNormal4(A*K[v]*c[G],A*K[v]*M[G],A*b[v],A*K[v]*c[G+1],A*K[v]*M[G+1],A*b[v],A*K[u]*c[G+1],A*K[u]*M[G+1],A*b[u],A*K[u]*c[G],A*K[u]*M[G],A*b[u],h)}}}for(var g=0;g<=L;g+=L){if(Math.abs(K[g])>=D){var e=K[g],x=b[g],H=(g===0)?0:1,F=1-H;for(var G=0;G<z;++G){l.AddFace4(B[1]*e*c[G+H],B[1]*e*M[G+H],B[1]*x,B[0]*e*c[G+H],B[0]*e*M[G+H],B[0]*x,B[0]*e*c[G+F],B[0]*e*M[G+F],B[0]*x,B[1]*e*c[G+F],B[1]*e*M[G+F],B[1]*x,E?2:0);l.CalcNormal()}}}if(N<360){for(var g=0;g<=z;g+=z){var e=M[g],x=c[g],H=(g===0)?1:0,F=1-H;for(var I=0;I<L;++I){l.AddFace4(B[1]*K[I+H]*x,B[1]*K[I+H]*e,B[1]*b[I+H],B[0]*K[I+H]*x,B[0]*K[I+H]*e,B[0]*b[I+H],B[0]*K[I+F]*x,B[0]*K[I+F]*e,B[0]*b[I+F],B[1]*K[I+F]*x,B[1]*K[I+F]*e,B[1]*b[I+F],E?2:0);l.CalcNormal()}}}return l.Create()};a.GEO.createTube=function(d){var f,z,e,y;if((d._typename=="TGeoCone")||(d._typename=="TGeoConeSeg")){f=d.fRmax2;z=d.fRmin2;e=d.fRmax1;y=d.fRmin1}else{f=e=d.fRmax;z=y=d.fRmin}var k=(z>0)||(y>0);if(k){if(z<=0){z=1e-7;a.GEO.warn("zero inner radius1 in tube - not yet supported")}if(y<=0){y=1e-7;a.GEO.warn("zero inner radius1 in tube - not yet supported")}}var j=0,p=360;if((d._typename=="TGeoConeSeg")||(d._typename=="TGeoTubeSeg")||(d._typename=="TGeoCtub")){j=d.fPhi1;p=d.fPhi2-d.fPhi1}var s=Math.round(p/a.GEO.GradPerSegm);if(s<4){s=4}var g=(p<360)?1:0;var o=s+g;var A=j*Math.PI/180,c=p/s*Math.PI/180;var h=new Float32Array(o),m=new Float32Array(o);for(var x=0;x<o;++x){m[x]=Math.cos(A+x*c);h[x]=Math.sin(A+x*c)}var l=new THREE.Geometry();if(k){for(var x=0;x<o;++x){l.vertices.push(new THREE.Vector3(z*m[x],z*h[x],d.fDZ))}for(var x=0;x<o;++x){l.vertices.push(new THREE.Vector3(y*m[x],y*h[x],-d.fDZ))}}else{l.vertices.push(new THREE.Vector3(0,0,d.fDZ));l.vertices.push(new THREE.Vector3(0,0,-d.fDZ))}var v=l.vertices.length;for(var x=0;x<o;++x){l.vertices.push(new THREE.Vector3(f*m[x],f*h[x],d.fDZ))}for(var x=0;x<o;++x){l.vertices.push(new THREE.Vector3(e*m[x],e*h[x],-d.fDZ))}if(d._typename=="TGeoCtub"){for(var q=0;q<l.vertices.length;++q){var w=l.vertices[q];if(w.z<0){w.z=-d.fDz-(w.x*d.fNlow[0]+w.y*d.fNlow[1])/d.fNlow[2]}else{w.z=d.fDz-(w.x*d.fNhigh[0]+w.y*d.fNhigh[1])/d.fNhigh[2]}}}var t=new THREE.Color();if(k){for(var x=0;x<s;++x){var b=(g===1)?(x+1):(x+1)%s;l.faces.push(new THREE.Face3(o+x,x,b,null,t,0));l.faces.push(new THREE.Face3(o+x,b,o+b,null,t,0))}}for(var x=0;x<s;++x){var b=(g===1)?(x+1):(x+1)%s;l.faces.push(new THREE.Face3(v+x,v+o+x,v+b,null,t,0));l.faces.push(new THREE.Face3(v+o+x,v+o+b,v+b,null,t,0))}for(var u=0;u<s;++u){var r=(g===1)?(u+1):(u+1)%s;if(k){l.faces.push(new THREE.Face3(u,u+v,r,null,t,0));l.faces.push(new THREE.Face3(u+v,r+v,r,null,t,0))}else{l.faces.push(new THREE.Face3(0,u+v,r+v,null,t,0))}}for(var u=0;u<s;++u){var r=(g===1)?(u+1):(u+1)%s;if(k){l.faces.push(new THREE.Face3(o+u+v,o+u,o+r,null,t,0));l.faces.push(new THREE.Face3(o+u+v,o+r,o+r+v,null,t,0))}else{l.faces.push(new THREE.Face3(o+u+v,1,o+r+v,null,t,0))}}if(g===1){if(k){l.faces.push(new THREE.Face3(0,o,v+o,null,t,0));l.faces.push(new THREE.Face3(0,v+o,v,null,t,0))}else{l.faces.push(new THREE.Face3(0,1,v+o,null,t,0));l.faces.push(new THREE.Face3(0,v+o,v,null,t,0))}if(k){l.faces.push(new THREE.Face3(s,v+2*s+1,2*s+1,null,t,0));l.faces.push(new THREE.Face3(s,v+s,v+2*s+1,null,t,0))}else{l.faces.push(new THREE.Face3(0,v+2*s+1,1,null,t,0));l.faces.push(new THREE.Face3(0,v+s,v+2*s+1,null,t,0))}}l.computeFaceNormals();return l};a.GEO.createTubeBuffer=function(f,n){var c,d;if((f._typename=="TGeoCone")||(f._typename=="TGeoConeSeg")){c=[f.fRmax2,f.fRmax1];d=[f.fRmin2,f.fRmin1]}else{c=[f.fRmax,f.fRmax];d=[f.fRmin,f.fRmin]}var l=(d[0]>0)||(d[1]>0);var j=0,q=360;if((f._typename=="TGeoConeSeg")||(f._typename=="TGeoTubeSeg")||(f._typename=="TGeoCtub")){j=f.fPhi1;q=f.fPhi2-f.fPhi1}var r=Math.max(4,Math.round(q/a.GEO.GradPerSegm));var s=r*(((c[0]<=0)||(c[1]<=0))?1:2);if(l){s+=r*(((d[0]<=0)||(d[1]<=0))?1:2)}if(c[0]>0){s+=r*((d[0]>0)?2:1)}if(c[1]>0){s+=r*((d[1]>0)?2:1)}if(q<360){s+=((c[0]>d[0])?2:0)+((c[1]>d[1])?2:0)}if(n<0){return s}var x=j*Math.PI/180,b=q/r*Math.PI/180,i=new Float32Array(r+1),m=new Float32Array(r+1);for(var t=0;t<=r;++t){m[t]=Math.cos(x+t*b);i[t]=Math.sin(x+t*b)}var o=n?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(s);var e;if(f._typename=="TGeoCtub"){e=function(B,D,C){var A=(C<0)?f.fNlow:f.fNhigh;return((C<0)?-f.fDz:f.fDz)-(B*A[0]+D*A[1])/A[2]}}for(var g=0;g<2;++g){if((g===1)&&!l){break}var k=(g===0)?c:d,z=g,y=1-g,h=1,v=0;if(k[0]!==k[1]){var u=Math.atan2((k[1]-k[0]),2*f.fDZ);h=Math.cos(u);v=Math.sin(u)}if(g===1){h*=-1;v*=-1}var p=0;if(k[0]<=0){p=2}else{if(k[1]<=0){p=1}}for(var t=0;t<r;++t){o.AddFace4(k[0]*m[t+z],k[0]*i[t+z],f.fDZ,k[1]*m[t+z],k[1]*i[t+z],-f.fDZ,k[1]*m[t+y],k[1]*i[t+y],-f.fDZ,k[0]*m[t+y],k[0]*i[t+y],f.fDZ,p);if(e){o.RecalcZ(e)}o.SetNormal_12_34(h*m[t+z],h*i[t+z],v,h*m[t+y],h*i[t+y],v,p)}}for(var g=0;g<2;++g){if(c[g]<=0){continue}var z=g,y=1-g,w=(g==0)?1:-1,p=(d[g]<=0)?2:0;if((p==2)&&(q===360)&&!e){o.StartPolygon(g===0)}for(var t=0;t<r;++t){o.AddFace4(d[g]*m[t+z],d[g]*i[t+z],w*f.fDZ,c[g]*m[t+z],c[g]*i[t+z],w*f.fDZ,c[g]*m[t+y],c[g]*i[t+y],w*f.fDZ,d[g]*m[t+y],d[g]*i[t+y],w*f.fDZ,p);if(e){o.RecalcZ(e);o.CalcNormal()}else{o.SetNormal(0,0,w)}}o.StopPolygon()}if(q<360){o.AddFace4(d[1]*m[0],d[1]*i[0],-f.fDZ,c[1]*m[0],c[1]*i[0],-f.fDZ,c[0]*m[0],c[0]*i[0],f.fDZ,d[0]*m[0],d[0]*i[0],f.fDZ,(c[0]===d[0])?2:((d[1]===c[1])?1:0));if(e){o.RecalcZ(e)}o.CalcNormal();o.AddFace4(d[0]*m[r],d[0]*i[r],f.fDZ,c[0]*m[r],c[0]*i[r],f.fDZ,c[1]*m[r],c[1]*i[r],-f.fDZ,d[1]*m[r],d[1]*i[r],-f.fDZ,(c[0]===d[0])?1:((d[1]===c[1])?2:0));if(e){o.RecalcZ(e)}o.CalcNormal()}return o.Create()};a.GEO.createEltu=function(g){var i=new THREE.Geometry();var c=Math.round(360/a.GEO.GradPerSegm);var j=new Float32Array(c),h=new Float32Array(c);for(var e=0;e<c;++e){var f=e/c*2*Math.PI;j[e]=g.fRmin*Math.cos(f);h[e]=g.fRmax*Math.sin(f)}for(var e=0;e<c;++e){i.vertices.push(new THREE.Vector3(j[e],h[e],-g.fDZ))}i.vertices.push(new THREE.Vector3(0,0,-g.fDZ));for(var e=0;e<c;++e){i.vertices.push(new THREE.Vector3(j[e],h[e],+g.fDZ))}i.vertices.push(new THREE.Vector3(0,0,g.fDZ));var d=new THREE.Color();for(var e=0;e<c;++e){var k=(e+1)%c;i.faces.push(new THREE.Face3(e+c+1,e,k,null,d,0));i.faces.push(new THREE.Face3(e+c+1,k,k+c+1,null,d,0))}for(var e=0;e<c;++e){i.faces.push(new THREE.Face3(e,c,(e+1)%c,null,d,0))}var b=c+1;for(var e=0;e<c;++e){i.faces.push(new THREE.Face3(b+e,b+(e+1)%c,b+c,null,d,0))}i.computeFaceNormals();return i};a.GEO.createEltuBuffer=function(j,p){var g=Math.max(4,Math.round(360/a.GEO.GradPerSegm));if(p<0){return g*4}var q=new Float32Array(g+1),o=new Float32Array(g+1);for(var h=0;h<=g;++h){var i=h/g*2*Math.PI;q[h]=j.fRmin*Math.cos(i);o[h]=j.fRmax*Math.sin(i)}var f=p?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(g*4);var c=1,n=0,r=1,l=0;for(var h=0;h<g;++h){f.AddFace4(q[h],o[h],+j.fDZ,q[h],o[h],-j.fDZ,q[h+1],o[h+1],-j.fDZ,q[h+1],o[h+1],j.fDZ);c=r;n=l;r=q[h+1]*j.fRmax/j.fRmin;l=o[h+1]*j.fRmin/j.fRmax;var m=Math.sqrt(r*r+l*l);r=r/m;l=l/m;f.SetNormal_12_34(c,n,0,r,l,0)}for(var k=0;k<2;++k){var e=(k===0)?1:-1,d=k,b=1-k;for(var h=0;h<g;++h){f.AddFace3(0,0,e*j.fDZ,q[h+d],o[h+d],e*j.fDZ,q[h+b],o[h+b],e*j.fDZ);f.SetNormal(0,0,e)}}return f.Create()};a.GEO.createTorus=function(c,i){var e=c.fR,y=c.fRmin,x=c.fRmax,h=c.fDphi-c.fPhi1,r=c.fPhi1,d=30,l=Math.max(8,Math.round(h/a.GEO.GradPerSegm)),f=y>0,v=(h!==360);if(i<0){return(f?4:2)*(d+1)*l}if(i>0){var b=(f?4:2)*(d+1)*l/i;if(b>1){d=Math.round(d/Math.sqrt(b));l=Math.round(l/Math.sqrt(b))}}var g=new THREE.Geometry();var s=new THREE.Color();var w=new THREE.TorusGeometry(e,x,d,l,h*Math.PI/180);w.applyMatrix(new THREE.Matrix4().makeRotationZ(r*Math.PI/180));for(var o=0;o<w.vertices.length;++o){g.vertices.push(w.vertices[o])}for(var o=0;o<w.faces.length;++o){var k=w.faces[o];g.faces.push(new THREE.Face3(k.a,k.b,k.c,null,s,0))}var u=g.vertices.length;if(f){var m=new THREE.TorusGeometry(e,y,d,l,h*Math.PI/180);m.applyMatrix(new THREE.Matrix4().makeRotationZ(r*Math.PI/180));for(var o=0;o<m.vertices.length;++o){g.vertices.push(m.vertices[o])}for(var o=0;o<m.faces.length;++o){var k=m.faces[o];g.faces.push(new THREE.Face3(u+k.a,u+k.c,u+k.b,null,s,0))}}else{if(v){g.vertices.push(new THREE.Vector3(e*Math.cos(r*Math.PI/180),e*Math.sin(r*Math.PI/180),0));g.vertices.push(new THREE.Vector3(e*Math.cos((r+h)*Math.PI/180),e*Math.sin((r+h)*Math.PI/180),0))}}if(h!==360){for(var t=0;t<d;t++){var q=t*(l+1);var p=(t+1)*(l+1);if(f){g.faces.push(new THREE.Face3(p,q+u,q,null,s,0));g.faces.push(new THREE.Face3(p,p+u,q+u,null,s,0))}else{g.faces.push(new THREE.Face3(u,q,p,null,s,0))}}for(var t=0;t<d;t++){var q=(t+1)*(l+1)-1;var p=(t+2)*(l+1)-1;if(f){g.faces.push(new THREE.Face3(p,q,q+u,null,s,0));g.faces.push(new THREE.Face3(p,q+u,p+u,null,s,0))}else{g.faces.push(new THREE.Face3(u+1,p,q,null,s,0))}}}g.computeFaceNormals();return g};a.GEO.createTorusBuffer=function(f,q){var k=f.fR,h=Math.max(6,Math.round(360/a.GEO.GradPerSegm)),v=Math.max(8,Math.round(f.fDphi/a.GEO.GradPerSegm));var F=(f.fRmin>0?4:2)*h*(v+(f.fDphi!==360?1:0));if(q<0){return F}if((q>0)&&(F>q)){h=Math.floor(h/Math.sqrt(F/q));v=Math.floor(v/Math.sqrt(F/q));F=(f.fRmin>0?4:2)*h*(v+(f.fDphi!==360?1:0))}var I=new Float32Array(h+1),y=new Float32Array(h+1),G=new Float32Array(v+1),x=new Float32Array(v+1);for(var C=0;C<=h;++C){I[C]=Math.sin(C/h*2*Math.PI);y[C]=Math.cos(C/h*2*Math.PI)}for(var A=0;A<=v;++A){var H=(f.fPhi1+f.fDphi*A/v)/180*Math.PI;G[A]=Math.sin(H);x[A]=Math.cos(H)}var s=q?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(F);var e=new THREE.Vector3(),d=new THREE.Vector3(),c=new THREE.Vector3(),b=new THREE.Vector3(),r=new THREE.Vector3(),p=new THREE.Vector3(),o=new THREE.Vector3(),m=new THREE.Vector3(),l=new THREE.Vector3(),j=new THREE.Vector3();for(var g=0;g<2;++g){if((g>0)&&(f.fRmin<=0)){break}var i=(g>0)?f.fRmin:f.fRmax,L=1-g,J=1-L,K=g>0?-1:1;for(var A=0;A<v;++A){var w=A+L,u=A+J;l.x=k*x[w];l.y=k*G[w];j.x=k*x[u];j.y=k*G[u];for(var C=0;C<h;++C){e.x=(k+i*y[C])*x[w];e.y=(k+i*y[C])*G[w];e.z=i*I[C];d.x=(k+i*y[C+1])*x[w];d.y=(k+i*y[C+1])*G[w];d.z=i*I[C+1];c.x=(k+i*y[C+1])*x[u];c.y=(k+i*y[C+1])*G[u];c.z=i*I[C+1];b.x=(k+i*y[C])*x[u];b.y=(k+i*y[C])*G[u];b.z=i*I[C];s.AddFace4(e.x,e.y,e.z,d.x,d.y,d.z,c.x,c.y,c.z,b.x,b.y,b.z);r.subVectors(e,l).normalize();p.subVectors(d,l).normalize();o.subVectors(c,j).normalize();m.subVectors(b,j).normalize();s.SetNormal4(K*r.x,K*r.y,K*r.z,K*p.x,K*p.y,K*p.z,K*o.x,K*o.y,K*o.z,K*m.x,K*m.y,K*m.z)}}}if(f.fDphi!==360){for(var A=0;A<=v;A+=v){var B=f.fRmax,z=f.fRmin,L=(A>0)?0:1,J=1-L,D=(f.fRmin)>0?0:1,E=A>0?1:-1;for(var C=0;C<h;++C){s.AddFace4((k+B*y[C+L])*x[A],(k+B*y[C+L])*G[A],B*I[C+L],(k+z*y[C+L])*x[A],(k+z*y[C+L])*G[A],z*I[C+L],(k+z*y[C+J])*x[A],(k+z*y[C+J])*G[A],z*I[C+J],(k+B*y[C+J])*x[A],(k+B*y[C+J])*G[A],B*I[C+J],D);s.SetNormal(-E*G[A],E*x[A],0)}}}return s.Create()};a.GEO.createPolygon=function(k){var p=k.fPhi1,w=k.fDphi;var x=60;if(k._typename=="TGeoPgon"){x=k.fNedges}else{x=Math.round(w/a.GEO.GradPerSegm);if(x<4){x=4}}var r=new THREE.Geometry();var y=new THREE.Color();var q=false;for(var O=0;O<k.fNz;++O){if(k.fRmin[O]>0){q=true}}var M=p*Math.PI/180,h=w/x*Math.PI/180;var n=new Float32Array(x+1),s=new Float32Array(x+1);for(var B=0;B<=x;++B){s[B]=Math.cos(M+B*h);n[B]=Math.sin(M+B*h)}var J=[[],[]],v=null,m=null;var P=x;if(w!==360){v=[];m=[];P+=1}var L,K,I,F,E;for(var l=0;l<2;++l){var u=(l===0)?"fRmax":"fRmin";var t=r.vertices.length;for(var O=0;O<k.fNz;++O){J[l][O]=r.vertices.length;var o=k.fZ[O],N=k[u][O];if((O>0)&&(O<k.fNz-1)){if(((k.fZ[O-1]===o)&&(k[u][O-1]===N))||((k[u][O+1]===N)&&(k[u][O-1]===N))){J[l][O]=J[l][O-1];continue}}if(N<=0){N=0.000001}var A=r.vertices.length;if((l===0)||q){for(var B=0;B<P;++B){r.vertices.push(new THREE.Vector3(N*s[B],N*n[B],o))}}else{r.vertices.push(new THREE.Vector3(0,0,o))}if(v!==null){if(l===0){v.push(new THREE.Vector2(N,o));m.push(A)}else{if(N<k.fRmax[O]){v.unshift(new THREE.Vector2(N,o));m.unshift(A)}}}if((O>0)&&((l===0)||q)){for(var B=0;B<x;++B){var g=(B+1)%P;r.faces.push(new THREE.Face3(t+B,(l===0)?(t+g):(A+B),A+g,null,y,0));r.faces.push(new THREE.Face3(t+B,A+g,(l===0)?(A+B):t+g,null,y,0))}}t=A}}for(var O=0;O<k.fNz;O+=(k.fNz-1)){if(k.fRmin[O]>=k.fRmax[O]){continue}var D=J[1][O],H=J[0][O];for(var B=0;B<x;++B){var g=(B+1)%P;if(q){r.faces.push(new THREE.Face3(H+B,(O===0)?(D+B):(H+g),D+g,null,y,0));r.faces.push(new THREE.Face3(H+B,D+g,(O===0)?(H+g):(D+B),null,y,0))}else{if(O==0){r.faces.push(new THREE.Face3(H+B,D,H+g,null,y,0))}else{r.faces.push(new THREE.Face3(H+g,D,H+B,null,y,0))}}}}if(v!==null){var j=[];if(v.length===k.fNz*2){for(var O=k.fNz-1;O>0;--O){if(k.fZ[O]===k.fZ[O-1]){continue}var G=2*k.fNz-1-O;j.push([G,O-1,O]);j.push([G,G+1,O-1])}}else{j=THREE.ShapeUtils.triangulateShape(v,[])}for(var z=0;z<j.length;++z){var C=j[z];r.faces.push(new THREE.Face3(m[C[0]],m[C[1]],m[C[2]],null,y,0))}for(var z=0;z<j.length;++z){var C=j[z];r.faces.push(new THREE.Face3(m[C[0]]+x,m[C[2]]+x,m[C[1]]+x,null,y,0))}}r.computeFaceNormals();return r};a.GEO.createPolygonBuffer=function(t,x){var M=t.fPhi1,w=t.fDphi,L=60;if(t._typename=="TGeoPgon"){L=t.fNedges}else{L=Math.max(5,Math.round(w/a.GEO.GradPerSegm))}var o=new Int16Array(2*t.fNz),O=0,y=false;for(var e=0;e<t.fNz;++e){if(t.fRmin[e]>0){y=true}}if(x<0){return(y?4:2)*L*(t.fNz-1)}var j=(w===360)?null:[];for(var r=0;r<2;++r){var h=(r===0)?"fRmax":"fRmin";for(var e=0;e<t.fNz;++e){var C=t.fZ[e],f=t[h][e];o[e*2+r]=0;if((e>0)&&(e<t.fNz-1)){if(((t.fZ[e-1]===C)&&(t[h][e-1]===f))||((t[h][e+1]===f)&&(t[h][e-1]===f))){continue}}if((e>0)&&((r===0)||y)){o[e*2+r]=1;O++}if(j!==null){if(r===0){j.push(new THREE.Vector2(f,C))}else{if(f<t.fRmax[e]){j.unshift(new THREE.Vector2(f,C))}}}}}var v=O*L*2;if(t.fRmin[0]!==t.fRmax[0]){v+=L*(y?2:1)}if(t.fRmin[t.fNz-1]!==t.fRmax[t.fNz-1]){v+=L*(y?2:1)}var K=null;if(j!==null){if(j.length===t.fNz*2){K=[];for(var e=t.fNz-1;e>0;--e){if(t.fZ[e]===t.fZ[e-1]){continue}var E=2*t.fNz-1-e;K.push([E,e-1,e]);K.push([E,E+1,e-1])}}else{console.log("trinagulate "+t.fName);K=THREE.ShapeUtils.triangulateShape(j,[]);console.log("trinagulate done "+K.length)}v+=K.length*2}var i=M*Math.PI/180,d=w/L*Math.PI/180;var l=new Float32Array(L+1),g=new Float32Array(L+1);for(var z=0;z<=L;++z){g[z]=Math.cos(i+z*d);l[z]=Math.sin(i+z*d)}var u=x?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(v);for(var r=0;r<2;++r){var h=(r===0)?"fRmax":"fRmin",B=t.fZ[0],p=t[h][0],J=1-r,I=r;for(var e=0;e<t.fNz;++e){if(o[e*2+r]===0){continue}var A=t.fZ[e],m=t[h][e],G=1,F=0;if((m!==p)){var s=Math.atan2((m-p),(A-B));G=Math.cos(s);F=Math.sin(s)}if(r>0){G*=-1;F*=-1}for(var z=0;z<L;++z){u.AddFace4(p*g[z+J],p*l[z+J],B,m*g[z+J],m*l[z+J],A,m*g[z+I],m*l[z+I],A,p*g[z+I],p*l[z+I],B);u.SetNormal_12_34(G*g[z+J],G*l[z+J],F,G*g[z+I],G*l[z+I],F)}B=A;p=m}}for(var e=0;e<t.fNz;e+=(t.fNz-1)){var D=t.fRmin[e],k=t.fRmax[e];if(D===k){continue}var C=t.fZ[e],J=(e===0)?1:0,I=1-J,q=(e===0)?-1:1;if(!y&&!K){u.StartPolygon(e>0)}for(var z=0;z<L;++z){u.AddFace4(D*g[z+J],D*l[z+J],C,k*g[z+J],k*l[z+J],C,k*g[z+I],k*l[z+I],C,D*g[z+I],D*l[z+I],C,y?0:2);u.SetNormal(0,0,q)}u.StopPolygon()}if(K){for(var z=0;z<=L;z+=L){var J=(z===0)?1:2,I=3-J;for(var H=0;H<K.length;++H){var Q=j[K[H][0]],P=j[K[H][J]],N=j[K[H][I]];u.AddFace3(Q.x*g[z],Q.x*l[z],Q.y,P.x*g[z],P.x*l[z],P.y,N.x*g[z],N.x*l[z],N.y);u.CalcNormal()}}}return u.Create()};a.GEO.createXtru=function(k,o){if(o<0){return 2*k.fNz*k.fNvert}var n=new THREE.Geometry(),l=new THREE.Color(),e=0,p=0;for(var j=0;j<k.fNz;++j){var b=k.fZ[j],d=k.fScale[j];e=p;p=n.vertices.length;for(var h=0;h<k.fNvert;++h){n.vertices.push(new THREE.Vector3(d*k.fX[h],d*k.fY[h],b))}if(j>0){for(var h=0;h<k.fNvert;++h){var m=(h+1)%k.fNvert;n.faces.push(new THREE.Face3(e+h,p+h,p+m,null,l,0));n.faces.push(new THREE.Face3(e+h,p+m,e+m,null,l,0))}}}var f=[];for(var h=0;h<k.fNvert;++h){f.push(new THREE.Vector2(k.fX[h],k.fY[h]))}var c=THREE.ShapeUtils.triangulateShape(f,[]);for(var g=0;g<c.length;++g){face=c[g];n.faces.push(new THREE.Face3(face[1],face[0],face[2],null,l,0));n.faces.push(new THREE.Face3(face[0]+p,face[1]+p,face[2]+p,null,l,0))}n.computeFaceNormals();return n};a.GEO.createXtruBuffer=function(b,f){var l=(b.fNz-1)*b.fNvert*2;if(f<0){return l+b.fNvert*3}var m=[];for(var r=0;r<b.fNvert;++r){m.push(new THREE.Vector2(b.fX[r],b.fY[r]))}var c=THREE.ShapeUtils.triangulateShape(m,[]);if(c.length<m.length-2){a.GEO.warn("Problem with XTRU shape "+b.fName+" with "+m.length+" vertices");c=[]}else{l+=c.length*2}var i=f?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(l);for(var v=0;v<b.fNz-1;++v){var k=b.fZ[v],q=b.fScale[v],j=b.fZ[v+1],p=b.fScale[v+1];for(var e=0;e<b.fNvert;++e){var d=(e+1)%b.fNvert;i.AddFace4(q*b.fX[e],q*b.fY[e],k,p*b.fX[e],p*b.fY[e],j,p*b.fX[d],p*b.fY[d],j,q*b.fX[d],q*b.fY[d],k);i.CalcNormal()}}for(v=0;v<=b.fNz-1;v+=(b.fNz-1)){var h=b.fZ[v],w=b.fScale[v];for(var o=0;o<c.length;++o){var g=c[o],u=m[g[0]],t=m[g[(v===0)?2:1]],s=m[g[(v===0)?1:2]];i.AddFace3(w*u.x,w*u.y,h,w*t.x,w*t.y,h,w*s.x,w*s.y,h);i.SetNormal(0,0,v===0?-1:1)}}return i.Create()};a.GEO.createParaboloid=function(e,m){var s=Math.round(360/6),o=30;if(m>0){var d=2*(s+1)*(o+1)/m;if(d>1){s=Math.round(s/Math.sqrt(d));o=Math.round(o/Math.sqrt(d))}}var f=new Float32Array(s),l=new Float32Array(s);for(var v=0;v<s;++v){l[v]=Math.cos(v/s*2*Math.PI);f[v]=Math.sin(v/s*2*Math.PI)}var k=new THREE.Geometry();var i=new THREE.Color();var w=-e.fDZ,y=e.fDZ,r=e.fRlo,t=e.fRhi;if(e.fA>=0){if(e.fB>w){w=e.fB}}else{if(e.fB<y){y=e.fB}}var p=Math.atan2(w,r),q=Math.atan2(y,t);var n=0,h=0;for(var z=0;z<=o+1;++z){var g=y,j=0;if((z===o+1)&&(h===0)){break}switch(z){case 0:g=w;j=r;break;case o:g=y;j=t;break;case o+1:g=y;j=0;break;default:var c=Math.tan(p+(q-p)*z/o);var x=c*c-4*e.fA*e.fB;j=0.5*(c+Math.sqrt(x))/e.fA;if(j<0.000001){j=0}g=j*c}var u=k.vertices.length;if(j===0){k.vertices.push(new THREE.Vector3(0,0,g))}else{for(var v=0;v<s;++v){k.vertices.push(new THREE.Vector3(j*l[v],j*f[v],g))}}if(z>0){for(var v=0;v<s;++v){var b=(v+1)%s;if(h===0){k.faces.push(new THREE.Face3(n,u+b,u+v,null,i,0))}else{if(j==0){k.faces.push(new THREE.Face3(n+v,n+b,u,null,i,0))}else{k.faces.push(new THREE.Face3(n+v,u+b,u+v,null,i,0));k.faces.push(new THREE.Face3(n+v,n+b,u+b,null,i,0))}}}}h=j;n=u}k.computeFaceNormals();return k};a.GEO.createParaboloidBuffer=function(d,l){var t=Math.max(4,Math.round(360/a.GEO.GradPerSegm)),n=30;if(l>0){var c=2*t*(n+1)/l;if(c>1){t=Math.max(5,Math.floor(t/Math.sqrt(c)));n=Math.max(5,Math.floor(n/Math.sqrt(c)))}}var z=-d.fDZ,B=d.fDZ,s=d.fRlo,u=d.fRhi;if(d.fA>=0){if(d.fB>z){z=d.fB}}else{if(d.fB<B){B=d.fB}}var o=Math.atan2(z,s),q=Math.atan2(B,u);var w=(n+1)*t*2;if(s===0){w-=t*2}if(u===0){w-=t*2}if(l<0){return w}var f=new Float32Array(t+1),k=new Float32Array(t+1);for(var x=0;x<=t;++x){k[x]=Math.cos(x/t*2*Math.PI);f[x]=Math.sin(x/t*2*Math.PI)}var m=l?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(w);var p=z,v=0,j=0,i=-1;for(var C=0;C<=n+1;++C){var g=0,h=0,e=0,y=-1;if((C===0)&&(s===0)){continue}if((C===n+1)&&(v===0)){break}switch(C){case 0:g=z;h=s;break;case n:g=B;h=u;break;case n+1:g=B;h=0;break;default:var b=Math.tan(o+(q-o)*C/n);var A=b*b-4*d.fA*d.fB;h=0.5*(b+Math.sqrt(A))/d.fA;if(h<0.000001){h=0}g=h*b}e=d.fA*h;y=(d.fA>0)?-1:1;var r=0;if(v===0){r=1}else{if(h===0){r=2}}for(var x=0;x<t;++x){m.AddFace4(h*k[x],h*f[x],g,v*k[x],v*f[x],p,v*k[x+1],v*f[x+1],p,h*k[x+1],h*f[x+1],g,r);if((r===0)||((C===1)&&(s===0))||((C===n+1)&&(u===0))){m.SetNormal4(e*k[x],e*f[x],y,j*k[x],j*f[x],i,j*k[x+1],j*f[x+1],i,e*k[x+1],e*f[x+1],y,r)}else{m.SetNormal(0,0,(C<n)?-1:1)}}p=g;v=h;j=e;i=y}return m.Create()};a.GEO.createHype=function(d,m){if((d.fTin===0)&&(d.fTout===0)){return a.GEO.createTubeBuffer(d,m)}var p=Math.max(4,Math.round(360/a.GEO.GradPerSegm)),o=30;if(m<0){return((d.fRmin<=0)?2:4)*(p+1)*(o+2)}if(m>0){var c=((d.fRmin<=0)?2:4)*(p+1)*(o+2)/m;if(c>1){p=Math.round(p/Math.sqrt(c));o=Math.round(o/Math.sqrt(c))}}var f=new Float32Array(p),k=new Float32Array(p);for(var s=0;s<p;++s){k[s]=Math.cos(s/p*2*Math.PI);f[s]=Math.sin(s/p*2*Math.PI)}var j=new THREE.Geometry();var g=new THREE.Color();var l=[[],[]];for(var e=0;e<2;++e){if((e===0)&&(d.fRmin<=0)){l[e][0]=j.vertices.length;j.vertices.push(new THREE.Vector3(0,0,-d.fDz));l[e][o]=j.vertices.length;j.vertices.push(new THREE.Vector3(0,0,d.fDz));continue}var n=0;var r=(e===0)?d.fRmin:d.fRmax;var v=(e===0)?d.fTinsq:d.fToutsq;for(var w=0;w<=o;++w){var h=-d.fDz+w/o*2*d.fDz;var i=Math.sqrt(r*r+v*h*h);var q=j.vertices.length;l[e][w]=q;for(var s=0;s<p;++s){j.vertices.push(new THREE.Vector3(i*k[s],i*f[s],h))}if(w>0){for(var s=0;s<p;++s){var b=(s+1)%p;j.faces.push(new THREE.Face3(n+s,(e===0)?(q+s):(n+b),q+b,null,g,0));j.faces.push(new THREE.Face3(n+s,q+b,(e===0)?(n+b):(q+s),null,g,0))}}n=q}}for(var w=0;w<=o;w+=o){var t=l[0][w],u=l[1][w];for(var s=0;s<p;++s){var b=(s+1)%p;if(d.fRmin<=0){j.faces.push(new THREE.Face3(t,u+(w===0?b:s),u+(w===0?s:b),null,g,0))}else{j.faces.push(new THREE.Face3(t+s,(w===0)?(t+b):(u+s),u+b,null,g,0));j.faces.push(new THREE.Face3(t+s,u+b,(w===0)?(u+s):(t+b),null,g,0))}}}j.computeFaceNormals();return j};a.GEO.createHypeBuffer=function(b,f){if((b.fTin===0)&&(b.fTout===0)){return a.GEO.createTubeBuffer(b,f)}var m=Math.max(4,Math.round(360/a.GEO.GradPerSegm)),k=30;var q=m*(k+1)*((b.fRmin>0)?4:2);if(f<0){return q}if((f>0)&&(f>q)){m=Math.max(4,Math.floor(m/Math.sqrt(q/f)));k=Math.max(4,Math.floor(k/Math.sqrt(q/f)));q=m*(k+1)*((b.fRmin>0)?4:2)}var d=new Float32Array(m+1),e=new Float32Array(m+1);for(var r=0;r<=m;++r){e[r]=Math.cos(r/m*2*Math.PI);d[r]=Math.sin(r/m*2*Math.PI)}var h=f?new a.GEO.PolygonsCreator:new a.GEO.GeometryCreator(q);for(var c=0;c<2;++c){if((c>0)&&(b.fRmin<=0)){break}var p=(c>0)?b.fRmin:b.fRmax,s=(c>0)?b.fTinsq:b.fToutsq,v=1-c,u=1-v;for(var t=0;t<k;++t){var j=-b.fDz+t/k*2*b.fDz,i=-b.fDz+(t+1)/k*2*b.fDz,o=Math.sqrt(p*p+s*j*j),n=Math.sqrt(p*p+s*i*i);for(var r=0;r<m;++r){h.AddFace4(o*e[r+v],o*d[r+v],j,n*e[r+v],n*d[r+v],i,n*e[r+u],n*d[r+u],i,o*e[r+u],o*d[r+u],j);h.CalcNormal()}}}for(var t=0;t<2;++t){var g=(t===0)?b.fDz:-b.fDz,o=Math.sqrt(b.fRmax*b.fRmax+b.fToutsq*g*g),n=(b.fRmin>0)?Math.sqrt(b.fRmin*b.fRmin+b.fTinsq*g*g):0,l=(b.fRmin>0)?0:1,v=1-t,u=1-v;for(var r=0;r<m;++r){h.AddFace4(o*e[r+v],o*d[r+v],g,n*e[r+v],n*d[r+v],g,n*e[r+u],n*d[r+u],g,o*e[r+u],o*d[r+u],g,l);h.SetNormal(0,0,(t===0)?1:-1)}}return h.Create()};a.GEO.createMatrix=function(c){if(c===null){return null}var e=null,b=null;if(c._typename=="TGeoTranslation"){e=c.fTranslation}else{if(c._typename=="TGeoRotation"){b=c.fRotationMatrix}else{if(c._typename=="TGeoCombiTrans"){e=c.fTranslation;if(c.fRotation!==null){b=c.fRotation.fRotationMatrix}}else{if(c._typename!=="TGeoIdentity"){}}}}if((e===null)&&(b===null)){return null}var d=new THREE.Matrix4();if(b!==null){d.set(b[0],b[1],b[2],0,b[3],b[4],b[5],0,b[6],b[7],b[8],0,0,0,0,1)}if(e!==null){d.setPosition(new THREE.Vector3(e[0],e[1],e[2]))}return d};a.GEO.getNodeMatrix=function(d,f){var b=null;if(d===1){b=new THREE.Matrix4();if(f.fTrans!==null){b.set(f.fTrans[0],f.fTrans[4],f.fTrans[8],0,f.fTrans[1],f.fTrans[5],f.fTrans[9],0,f.fTrans[2],f.fTrans[6],f.fTrans[10],0,0,0,0,1);b.setPosition({x:f.fTrans[12],y:f.fTrans[13],z:f.fTrans[14]})}}else{if(("fMatrix" in f)&&(f.fMatrix!==null)){b=a.GEO.createMatrix(f.fMatrix)}else{if((f._typename=="TGeoNodeOffset")&&(f.fFinder!==null)){if((f.fFinder._typename==="TGeoPatternX")||(f.fFinder._typename==="TGeoPatternY")||(f.fFinder._typename==="TGeoPatternZ")||(f.fFinder._typename==="TGeoPatternParaX")||(f.fFinder._typename==="TGeoPatternParaY")||(f.fFinder._typename==="TGeoPatternParaZ")){var g=f.fFinder.fStart+(f.fIndex+0.5)*f.fFinder.fStep;b=new THREE.Matrix4();switch(f.fFinder._typename.charAt(f.fFinder._typename.length-1)){case"X":b.setPosition(new THREE.Vector3(g,0,0));break;case"Y":b.setPosition(new THREE.Vector3(0,g,0));break;case"Z":b.setPosition(new THREE.Vector3(0,0,g));break}}else{if(f.fFinder._typename==="TGeoPatternCylPhi"){var e=(Math.PI/180)*(f.fFinder.fStart+(f.fIndex+0.5)*f.fFinder.fStep);var h=Math.cos(e),c=Math.sin(e);b=new THREE.Matrix4();b.set(h,-c,0,0,c,h,0,0,0,0,1,0,0,0,0,1)}else{if(f.fFinder._typename==="TGeoPatternCylR"){b=new THREE.Matrix4()}else{a.GEO.warn("Unsupported pattern type "+f.fFinder._typename)}}}}}}return b};a.GEO.createComposite=function(f,h){if(h<0){return a.GEO.createGeometry(f.fNode.fLeft,-1)+a.GEO.createGeometry(f.fNode.fRight,-1)}var i,g,e,d,c=false,b=a.GEO.createMatrix(f.fNode.fLeftMat),j=a.GEO.createMatrix(f.fNode.fRightMat);if(h===0){h=10000}else{c=true}if(b&&(b.determinant()<-0.9)){a.GEO.warn("Axis reflection in composite shape - not supported")}if(j&&(j.determinant()<-0.9)){a.GEO.warn("Axis reflections in composite shape - not supported")}i=a.GEO.createGeometry(f.fNode.fLeft,h/2);g=a.GEO.createGeometry(f.fNode.fRight,h/2);if(i instanceof THREE.Geometry){i.computeVertexNormals()}e=new ThreeBSP(i,b,a.GEO.CompressComp?0:undefined);if(g instanceof THREE.Geometry){g.computeVertexNormals()}d=new ThreeBSP(g,j,e.maxid);e.maxid=d.maxid;switch(f.fNode._typename){case"TGeoIntersection":e.direct_intersect(d);break;case"TGeoUnion":e.direct_union(d);break;case"TGeoSubtraction":e.direct_subtract(d);break;default:a.GEO.warn("unsupported bool operation "+f.fNode._typename+", use first geom")}if(a.GEO.numGeometryFaces(e)===0){a.GEO.warn("Zero faces in comp shape left: "+f.fNode.fLeft._typename+" "+a.GEO.numGeometryFaces(i)+" faces right: "+f.fNode.fRight._typename+" "+a.GEO.numGeometryFaces(g)+" faces  use first");e=new ThreeBSP(i,b)}return c?{polygons:e.toPolygons()}:e.toBufferGeometry()};a.GEO.createGeometry=function(d,c){if(c===undefined){c=0}try{switch(d._typename){case"TGeoBBox":return a.GEO.createCubeBuffer(d,c);case"TGeoPara":return a.GEO.createParaBuffer(d,c);case"TGeoTrd1":case"TGeoTrd2":return a.GEO.createTrapezoidBuffer(d,c);case"TGeoArb8":case"TGeoTrap":case"TGeoGtra":return a.GEO.createArb8Buffer(d,c);case"TGeoSphere":return a.GEO.createSphereBuffer(d,c);case"TGeoCone":case"TGeoConeSeg":case"TGeoTube":case"TGeoTubeSeg":case"TGeoCtub":return a.GEO.createTubeBuffer(d,c);case"TGeoEltu":return a.GEO.createEltuBuffer(d,c);case"TGeoTorus":return a.GEO.createTorusBuffer(d,c);case"TGeoPcon":case"TGeoPgon":return a.GEO.createPolygonBuffer(d,c);case"TGeoXtru":return a.GEO.createXtruBuffer(d,c);case"TGeoParaboloid":return a.GEO.createParaboloidBuffer(d,c);case"TGeoHype":return a.GEO.createHypeBuffer(d,c);case"TGeoCompositeShape":return a.GEO.createComposite(d,c);case"TGeoShapeAssembly":break}}catch(f){var b="";if(f.stack!==undefined){b=f.stack.split("\n")[0];if(b.indexOf(f.message)>=0){b=f.stack.split("\n")[1]}else{b=" at: "+b}}a.GEO.warn(d._typename+" err: "+f.message+b)}return c<0?0:null};a.GEO.CreateProjectionMatrix=function(c){var b=new THREE.Matrix4();c.updateMatrixWorld();c.matrixWorldInverse.getInverse(c.matrixWorld);b.multiplyMatrices(c.projectionMatrix,c.matrixWorldInverse);return b};a.GEO.CreateFrustum=function(c){if(!c){return null}if(c instanceof THREE.PerspectiveCamera){c=a.GEO.CreateProjectionMatrix(c)}var b=new THREE.Frustum();b.setFromMatrix(c);b.corners=new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,-1,0,0,0]);b.test=new THREE.Vector3(0,0,0);b.CheckShape=function(g,f){var j=this.test,d=this.corners.length,e=this.corners,h;for(h=0;h<d;h+=3){j.x=e[h]*f.fDX;j.y=e[h+1]*f.fDY;j.z=e[h+2]*f.fDZ;if(this.containsPoint(j.applyMatrix4(g))){return true}}return false};b.CheckBox=function(e){var f=this.test,d=0;f.set(e.min.x,e.min.y,e.min.z);if(this.containsPoint(f)){d++}f.set(e.min.x,e.min.y,e.max.z);if(this.containsPoint(f)){d++}f.set(e.min.x,e.max.y,e.min.z);if(this.containsPoint(f)){d++}f.set(e.min.x,e.max.y,e.max.z);if(this.containsPoint(f)){d++}f.set(e.max.x,e.max.y,e.max.z);if(this.containsPoint(f)){d++}f.set(e.max.x,e.min.y,e.max.z);if(this.containsPoint(f)){d++}f.set(e.max.x,e.max.y,e.min.z);if(this.containsPoint(f)){d++}f.set(e.max.x,e.max.y,e.max.z);if(this.containsPoint(f)){d++}return d>5};return b};a.GEO.VisibleByCamera=function(g,e,d){var h=new THREE.Frustum();var b=new THREE.Matrix4();g.updateMatrixWorld();g.matrixWorldInverse.getInverse(g.matrixWorld);b.multiplyMatrices(g.projectionMatrix,g.matrixWorldInverse);h.setFromMatrix(b);var c=[new THREE.Vector3(d.fDX/2,d.fDY/2,d.fDZ/2),new THREE.Vector3(d.fDX/2,d.fDY/2,-d.fDZ/2),new THREE.Vector3(d.fDX/2,-d.fDY/2,d.fDZ/2),new THREE.Vector3(d.fDX/2,-d.fDY/2,-d.fDZ/2),new THREE.Vector3(-d.fDX/2,d.fDY/2,d.fDZ/2),new THREE.Vector3(-d.fDX/2,d.fDY/2,-d.fDZ/2),new THREE.Vector3(-d.fDX/2,-d.fDY/2,d.fDZ/2),new THREE.Vector3(-d.fDX/2,-d.fDY/2,-d.fDZ/2)];for(var f=0;f<c.length;f++){if(h.containsPoint(c[f].applyMatrix4(e))){return true}}return false};a.GEO.numGeometryFaces=function(c){if(!c){return 0}if(c instanceof ThreeBSP){return c.tree.numPolygons()}if(c.type=="BufferGeometry"){var b=c.getAttribute("position");return b?b.count/3:0}if(c&&c.polygons){return c.polygons.length}return c.faces.length};a.GEO.numGeometryVertices=function(c){if(!c){return 0}if(c instanceof ThreeBSP){return c.tree.numPolygons()*3}if(c.type=="BufferGeometry"){var b=c.getAttribute("position");return b?b.count:0}if(c&&c.polygons){return c.polygons.length*4}return c.vertices.length};a.GEO.ClonedNodes=function(c,b){this.toplevel=true;if(c){if(c._geoh){this.toplevel=false}this.CreateClones(c)}else{if(b){this.nodes=b}}};a.GEO.ClonedNodes.prototype.GetNodeShape=function(b){if(!this.origin||!this.nodes){return null}var c=this.origin[b],d=this.nodes[b];if(!c||!d){return null}if(d.kind===0){if(c.fVolume){return c.fVolume.fShape}}else{return c.fShape}return null};a.GEO.ClonedNodes.prototype.CreateClones=function(g,b){if(!b){this.origin=[];b=1}var e=a.GEO.NodeKind(g);if((e<0)||("_refid" in g)){return}g._refid=this.origin.length;this.origin.push(g);var q=null;if(e===0){q=(g.fVolume&&g.fVolume.fNodes)?g.fVolume.fNodes.arr:null}else{q=g.fElements?g.fElements.arr:null}if(q!==null){for(var h=0;h<q.length;++h){this.CreateClones(q[h],b+1)}}if(b>1){return}this.nodes=[];var p=[];for(var c=0;c<this.origin.length;++c){var g=this.origin[c];var d={id:c,kind:a.GEO.NodeKind(g),vol:0,nfaces:0,numvischld:1,idshift:0};this.nodes.push(d);p.push(d)}for(var c=0;c<this.origin.length;++c){var g=this.origin[c],m=this.nodes[c];var q=null,j=null;if(m.kind===0){if(g.fVolume){j=g.fVolume.fShape;if(g.fVolume.fNodes){q=g.fVolume.fNodes.arr}}}else{j=g.fShape;if(g.fElements){q=g.fElements.arr}}var o=a.GEO.getNodeMatrix(m.kind,g);if(o){m.matrix=o.elements;if(m.matrix[0]===1){var l=true;for(var f=1;(f<m.matrix.length)&&l;++f){l=(m.matrix[f]===((f===5)||(f===10)||(f===15)?1:0))}if(l){delete m.matrix}}}if(j){m.fDX=j.fDX;m.fDY=j.fDY;m.fDZ=j.fDZ;m.vol=j.fDX*j.fDY*j.fDZ;if(j._nfaces===undefined){j._nfaces=a.GEO.createGeometry(j,-1)}m.nfaces=j._nfaces;if(m.nfaces<=0){m.vol=0}}if(!q){continue}m.chlds=new Int32Array(q.length);for(var f=0;f<q.length;++f){m.chlds[f]=q[f]._refid}}for(var c=0;c<this.origin.length;++c){delete this.origin[c]._refid}p.sort(function(k,i){return i.vol-k.vol});this.sortmap=new Int32Array(this.nodes.length);for(var c=0;c<this.nodes.length;++c){this.sortmap[c]=p[c].id}};a.GEO.ClonedNodes.prototype.MarkVisisble=function(i,d,f){if(!this.nodes){return 0}var b=0,c=f&&(f.length===this.nodes.length);if(!c&&!this.origin){return 0}for(var h=0;h<this.nodes.length;++h){var g=this.nodes[h];g.vis=false;g.numvischld=1;g.idshift=0;delete g.depth;if(c){g.vis=f[h].vis;if(f[h].depth!==undefined){g.depth=f[h].depth}if(g.vis){b++}continue}var e=this.origin[h];if(g.kind===0){if(e.fVolume){if(i){g.vis=a.GEO.TestBit(e.fVolume,a.GEO.BITS.kVisOnScreen);if(d){a.GEO.SetBit(e.fVolume,a.GEO.BITS.kVisNone,false);a.GEO.SetBit(e.fVolume,a.GEO.BITS.kVisThis,g.vis);a.GEO.SetBit(e.fVolume,a.GEO.BITS.kVisDaughters,true)}}else{g.vis=!a.GEO.TestBit(e.fVolume,a.GEO.BITS.kVisNone)&&a.GEO.TestBit(e.fVolume,a.GEO.BITS.kVisThis);if(!a.GEO.TestBit(e.fVolume,a.GEO.BITS.kVisDaughters)){g.depth=a.GEO.TestBit(e.fVolume,a.GEO.BITS.kVisOneLevel)?1:0}}}}else{g.vis=e.fRnrSelf;if((h===0)&&(this.nodes.length===1)){g.vis=true}}if((g.vol<=0)||(g.nfaces<=0)){g.vis=false}if(g.vis){b++}}return b};a.GEO.ClonedNodes.prototype.GetVisibleFlags=function(){var b=[];for(var d=0;d<this.nodes.length;++d){var c={vis:this.nodes[d].vis};if("depth" in this.nodes[d]){c.depth=this.nodes[d].depth}b.push(c)}return b};a.GEO.ClonedNodes.prototype.ScanVisible=function(b,j){if(!this.nodes){return 0}if(j===undefined){j=99999;if(!b){b={}}b.stack=new Int32Array(100);b.nodeid=0;b.counter=0;b.last=0;b.CopyStack=function(i){var k={nodeid:this.nodeid,seqid:this.counter,stack:new Int32Array(this.last)};if(i){k.factor=i}for(var l=0;l<this.last;++l){k.stack[l]=this.stack[l+1]}return k};if(b.domatrix){b.matrices=[];b.mpool=[new THREE.Matrix4()];b.getmatrix=function(){return this.matrices[this.last]}}}var f=0,h=this.nodes[b.nodeid];if(b.domatrix){if(!b.mpool[b.last+1]){b.mpool[b.last+1]=new THREE.Matrix4()}var e=(b.last>0)?b.matrices[b.last-1]:new THREE.Matrix4();if(h.matrix){b.matrices[b.last]=b.mpool[b.last].fromArray(e.elements);b.matrices[b.last].multiply(b.mpool[b.last+1].fromArray(h.matrix))}else{b.matrices[b.last]=e}}if(h.vis&&(j>=0)){if(!b.func||b.func(h)){f++}}b.counter++;if((h.depth!==undefined)&&(j>h.depth)){j=h.depth}if(b.last>b.stack.length-2){throw"stack capacity is not enough "+b.stack.length}if(h.chlds&&(h.numvischld>0)){var d=b.counter,g=0;b.last++;for(var c=0;c<h.chlds.length;++c){b.nodeid=h.chlds[c];b.stack[b.last]=c;g+=this.ScanVisible(b,j-1)}b.last--;f+=g;if(g===0){h.numvischld=0;h.idshift=b.counter-d}}else{b.counter+=h.idshift}if(b.last===0){delete b.last;delete b.stack;delete b.CopyStack;delete b.counter;delete b.matrices;delete b.mpool;delete b.getmatrix}return f};a.GEO.ClonedNodes.prototype.ResolveStack=function(b,d){var e={id:0,obj:null,node:this.nodes[0],name:"Nodes"};if(!this.toplevel||(this.nodes.length===1)||(e.node.kind===1)){e.name=""}if(d){e.matrix=new THREE.Matrix4();if(e.node.matrix){e.matrix.fromArray(e.node.matrix)}}if(this.origin){e.obj=this.origin[0]}if(b){for(var c=0;c<b.length;++c){e.id=e.node.chlds[b[c]];e.node=this.nodes[e.id];if(this.origin){e.obj=this.origin[e.id];if(e.obj.fName!==""){if(e.name.length>0){e.name+="/"}e.name+=e.obj.fName}}if(d&&e.node.matrix){e.matrix.multiply(new THREE.Matrix4().fromArray(e.node.matrix))}}}return e};a.GEO.ClonedNodes.prototype.FindStackByName=function(j){if(!this.origin){return null}var h=j.split("/");var f=0,i=[];for(var c=0;c<h.length;++c){var d=this.nodes[f];if(!d.chlds){return null}for(var e=0;e<d.chlds.length;++e){var b=d.chlds[e];var g=this.origin[b];if(g&&(g.fName===h[c])){i.push(e);f=b;break}}if(i.length==c){return null}}return i};a.GEO.ClonedNodes.prototype.CreateObject3D=function(j,k,p){var d=this.nodes[0],m=k,b=(typeof p=="object")||(p==="force");for(var h=0;h<=j.length;++h){var e=(h>0)?j[h-1]:0;if(h>0){d=this.nodes[d.chlds[e]]}var g=undefined;if(m.children){for(var f=0;f<m.children.length;++f){if(m.children[f].nchld===e){g=m.children[f];break}}}if(g){m=g;continue}if(!b){return null}g=new THREE.Object3D();if(d.matrix){g.matrix.fromArray(d.matrix);g.matrix.decompose(g.position,g.quaternion,g.scale)}g.nchld=e;m.add(g);if((h==0)&&(typeof p=="object")&&p.scale){if((p.scale.x<0)||(p.scale.y<0)||(p.scale.z<0)){g.scale.copy(p.scale);g.updateMatrix()}}g.updateMatrixWorld();m=g}if((p==="mesh")||(p==="delete_mesh")){var o=null;if(m){for(var c=0;(c<m.children.length)&&!o;++c){var l=m.children[c];if((l.type==="Mesh")&&(l.nchld===undefined)){o=l}}}if((p==="mesh")||!o){return o}while(o&&(o!==k)){m=o.parent;m.remove(o);o=(m.children.length==0)?m:null}return null}return m};a.GEO.ClonedNodes.prototype.GetVolumeBoundary=function(f,j,i){if(!this.sortmap){console.error("sorting map not exisits");return{min:0,max:1}}var b,h,e=0,g=0;for(var d=0;(d<this.sortmap.length)&&(e<i)&&(g<j);++d){var c=this.sortmap[d];if(f[c]===0){continue}h=this.nodes[c];if(!b){b=h}e+=f[c];g+=f[c]*h.nfaces}if(!h){console.error("no volumes selected");return{min:0,max:1}}return{min:h.vol,max:b.vol}};a.GEO.ClonedNodes.prototype.CollectVisibles=function(h,i){var k={facecnt:0,viscnt:new Int32Array(this.nodes.length),func:function(m){this.facecnt+=m.nfaces;this.viscnt[m.id]++;return true}};for(var d=0;d<k.viscnt.length;++d){k.viscnt[d]=0}var g=this.ScanVisible(k),l=0,b=0,j=-1,f=10;if(k.facecnt>h){var e=h*(i?0.8:1);var c=this.GetVolumeBoundary(k.viscnt,e,e/100);l=c.min;b=c.max;if(i){k.domatrix=true;k.frustum=i;k.totalcam=0;k.func=function(m){if(m.vol<=l){if(this.frustum.CheckShape(this.getmatrix(),m)){this.viscnt[m.id]++;this.totalcam+=m.nfaces}}return true};for(var d=0;d<k.viscnt.length;++d){k.viscnt[d]=0}this.ScanVisible(k);if(k.totalcam>h*0.2){j=this.GetVolumeBoundary(k.viscnt,h*0.2,h*0.2/100).min}else{j=0}f=b/((j>0)?(j>0):l)}}k.items=[];k.func=function(m){if(m.vol>l){this.items.push(this.CopyStack())}else{if((j>=0)&&(m.vol>j)){if(this.frustum.CheckShape(this.getmatrix(),m)){this.items.push(this.CopyStack(f))}}}return true};this.ScanVisible(k);return{lst:k.items,complete:l===0}};a.GEO.ClonedNodes.prototype.MergeVisibles=function(f,e){var c=0,b=[];for(var d=0;(d<f.length)&&(c<e.length);++d){while((c<e.length)&&(e[c].seqid<f[d].seqid)){b.push(e[c++])}if((c<e.length)&&(e[c].seqid===f[d].seqid)){if(e[c].done){f[d].done=true}c++}}while(c<e.length){b.push(e[c++])}return b};a.GEO.ClonedNodes.prototype.CollectShapes=function(b){var c=[];for(var e=0;e<b.length;++e){var g=b[e];var d=this.GetNodeShape(g.nodeid);if(!d){continue}if(d._id===undefined){d._id=c.length;c.push({id:d._id,shape:d,vol:this.nodes[g.nodeid].vol,refcnt:1,factor:1,ready:false})}else{c[d._id].refcnt++}g.shape=c[d._id];if(g.factor&&(g.factor>g.shape.factor)){g.shape.factor=g.factor}}c.sort(function(j,i){return i.vol*i.factor-j.vol*j.factor});for(var h=0;h<c.length;++h){var f=c[h];f.id=h;delete f.shape._id}for(var e=0;e<b.length;++e){var g=b[e];g.shapeid=g.shape.id;delete g.shape}return c};a.GEO.ClonedNodes.prototype.MergeShapesLists=function(c,d){if(!c){return d}for(var e=0;e<c.length;++e){var b=c[e];b.shape._geom=b.geom;delete b.geom;if(b.geomZ!==undefined){b.shape._geomZ=b.geomZ;delete b.geomZ}}for(var e=0;e<d.length;++e){var b=d[e];if(b.shape._geom!==undefined){b.geom=b.shape._geom;delete b.shape._geom}if(b.shape._geomZ!==undefined){b.geomZ=b.shape._geomZ;delete b.shape._geomZ}}for(var e=0;e<c.length;++e){var b=c[e];delete b.shape._geom;delete b.shape._geomZ}return d};a.GEO.ClonedNodes.prototype.BuildShapes=function(g,f,i){var e=0,c=new Date().getTime(),h={done:false,shapes:0,faces:0,notusedshapes:0};for(var d=0;d<g.length;++d){var j=g[d];if(h.done){j.ready=true;continue}if(!j.ready){if(j.geom===undefined){j.geom=a.GEO.createGeometry(j.shape);if(j.geom){e++}}j.nfaces=a.GEO.numGeometryFaces(j.geom);j.ready=true}h.shapes++;if(!j.used){h.notusedshapes++}h.faces+=j.nfaces*j.refcnt;if(h.faces>=f){h.done=true}else{if((e>0.01*g.length)&&(i!==undefined)){var b=new Date().getTime();if(b-c>i){return h}}}}h.done=true;return h};return a}));