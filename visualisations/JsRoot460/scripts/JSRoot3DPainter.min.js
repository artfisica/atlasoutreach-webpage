(function(a){if(typeof define==="function"&&define.amd){define(["d3","JSRootPainter","threejs_all"],a)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRoot3DPainter.js")}if(typeof d3!="object"){throw new Error("This extension requires d3.v3.js","JSRoot3DPainter.js")}if(typeof JSROOT.Painter!="object"){throw new Error("JSROOT.Painter is not defined","JSRoot3DPainter.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRoot3DPainter.js")}a(d3,JSROOT)}}(function(b,a){a.Painter.TestWebGL=function(){if(a.gStyle.NoWebGL){return false}if("_Detect_WebGL" in this){return this._Detect_WebGL}try{var c=document.createElement("canvas");this._Detect_WebGL=!!(window.WebGLRenderingContext&&(c.getContext("webgl")||c.getContext("experimental-webgl")))}catch(d){return false}return this._Detect_WebGL};a.Painter.TooltipFor3D=function(d,c){this.tt=null;this.cont=null;this.lastlbl="";this.parent=d?d:document.body;this.canvas=c;this.abspos=!d;this.pos=function(n){if(this.tt===null){return}var k,h;if(this.abspos){h=a.browser.isIE?(n.clientX+document.documentElement.scrollLeft):n.pageX;k=a.browser.isIE?(n.clientY+document.documentElement.scrollTop):n.pageY}else{h=n.offsetX;k=n.offsetY;var i=this.parent.getBoundingClientRect(),g=this.canvas.getBoundingClientRect();if((i.left!==undefined)&&(g.left!==undefined)){h+=(g.left-i.left)}if((i.top!==undefined)&&(g.top!==undefined)){k+=g.top-i.top}if(h+this.tt.offsetWidth+3>=this.parent.offsetWidth){h=this.parent.offsetWidth-this.tt.offsetWidth-3}if(k+this.tt.offsetHeight+15>=this.parent.offsetHeight){k=this.parent.offsetHeight-this.tt.offsetHeight-15}var f=this.parent;while(f){var m=getComputedStyle(f);if(!m||(m.position!=="static")){break}if(!f.parentNode||(f.parentNode.nodeType!=1)){break}f=f.parentNode}if(f&&(f!==this.parent)){var j=f.getBoundingClientRect();h+=(i.left-j.left);k+=(i.top-j.top)}}this.tt.style.top=(k+15)+"px";this.tt.style.left=(h+3)+"px"};this.show=function(f){if(a.gStyle.Tooltip<=0){return}if(!f||f===""){return this.hide()}if(this.tt===null){this.tt=document.createElement("div");this.tt.setAttribute("class","jsroot");var g=document.createElement("div");g.setAttribute("class","tt3d_border");this.cont=document.createElement("div");this.cont.setAttribute("class","tt3d_cont");var e=document.createElement("div");e.setAttribute("class","tt3d_border");this.tt.appendChild(g);this.tt.appendChild(this.cont);this.tt.appendChild(e);this.tt.style.opacity=1;this.tt.style.filter="alpha(opacity=1)";this.tt.style.position="absolute";this.tt.style.display="block";this.tt.style.overflow="hidden";this.parent.appendChild(this.tt)}if(this.lastlbl!==f){this.cont.innerHTML=f;this.lastlbl=f;this.tt.style.width="auto";if(a.browser.isIE){this.tt.style.width=this.tt.offsetWidth}}};this.hide=function(){if(this.tt!==null){this.parent.removeChild(this.tt)}this.tt=null;this.lastlbl=""};return this};a.Painter.CreateOrbitControl=function(u,q,s,o,v){var i=new THREE.OrbitControls(q,o.domElement);i.enableDamping=false;i.dampingFactor=1;i.enableZoom=true;if(v){i.target.copy(v);i.target0.copy(v);i.update()}var p={x:0,y:0,on:false},m=new THREE.Raycaster(),k=o instanceof THREE.WebGLRenderer,l=false,f=false,c=false,e=new a.Painter.TooltipFor3D(u.select_main().node(),o.domElement);i.ProcessMouseDblclick=function(){i.reset()};i.HideTooltip=function(){e.hide()};function h(x,w){w.x=("offsetX" in x)?x.offsetX:x.layerX;w.y=("offsetY" in x)?x.offsetY:x.layerY;w.clientX=x.clientX;w.clientY=x.clientY;return w}function n(w){var z=k?o.getSize():o.domElement;var y={x:w.x/z.width*2-1,y:-w.y/z.height*2+1};q.updateMatrix();q.updateMatrixWorld();m.setFromCamera(y,q);var x=m.intersectObjects(s.children,true);if(typeof u.FilterIntersects=="function"){x=u.FilterIntersects(x)}return x}i.addEventListener("change",function(){p.on=false;u.Render3D(0);f=true});i.addEventListener("start",function(){l=true;c=false;p.on=false;e.hide()});i.addEventListener("end",function(){l=false;if(p.on){p.on=false;i.ContextMenu(p,n(p))}else{if(f){}}f=false});function t(w){w.preventDefault();h(w,p);if(l){p.on=true}else{if(c){c=false}else{i.ContextMenu(p,n(p))}}}function j(w){if(!w.touches){return}if(!f&&!p.touchtm){h(w.touches[0],p);p.touchtm=new Date().getTime()}}function d(y){if(!y.touches){return}if(f||!p.touchtm){return}var w=new Date().getTime()-p.touchtm;delete p.touchtm;if(w<200){return}var x=h(y.touches[0],{});if((Math.abs(x.x-p.x)<=10)&&(Math.abs(x.y-p.y)<=10)){i.ContextMenu(p,n(p))}}i.ContextMenu=function(x,w){};function g(z){if(l&&z.buttons&&(z.buttons&2)){c=true}if(l||!i.ProcessMouseMove){return}var w=h(z,{});z.preventDefault();var x=n(w);var y=i.ProcessMouseMove(x);if(y&&(y.length>0)){e.show(y,200);e.pos(z)}else{e.hide()}}function r(){e.hide();if(i.ProcessMouseLeave){i.ProcessMouseLeave()}}o.domElement.addEventListener("dblclick",function(){i.ProcessMouseDblclick()});o.domElement.addEventListener("contextmenu",t);o.domElement.addEventListener("mousemove",g);o.domElement.addEventListener("mouseleave",r);return i};a.Painter.DisposeThreejsObject=function(d){if(!d){return}if(d.children){for(var c=0;c<d.children.length;c++){a.Painter.DisposeThreejsObject(d.children[c])}d.children=undefined}if(d.geometry){d.geometry.dispose();d.geometry=undefined}if(d.material){if(d.material.map){d.material.map.dispose();d.material.map=undefined}d.material.dispose();d.material=undefined}d=undefined};a.Painter.HPainter_Create3DScene=function(c){if((c!==undefined)&&(c<0)){if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(null,this.toplevel)}this.clear_3d_canvas();a.Painter.DisposeThreejsObject(this.scene);if(this.control){this.control.dispose()}delete this.size3d;delete this.scene;delete this.toplevel;delete this.tooltip_mesh;delete this.camera;delete this.pointLight;delete this.renderer;delete this.control;if("render_tmout" in this){clearTimeout(this.render_tmout);delete this.render_tmout}return}if("toplevel" in this){this.scene.remove(this.toplevel);a.Painter.DisposeThreejsObject(this.toplevel);delete this.toplevel;delete this.tooltip_mesh;if(this.control){this.control.HideTooltip()}var f=new THREE.Object3D();this.scene.add(f);this.toplevel=f;return}var e=this.size_for_3d();this.size3d=100;this.scene=new THREE.Scene();this.toplevel=new THREE.Object3D();this.scene.add(this.toplevel);this.scene_width=e.width;this.scene_height=e.height;this.camera=new THREE.PerspectiveCamera(45,this.scene_width/this.scene_height,1,40*this.size3d);this.camera.position.set(-1.6*this.size3d,-3.5*this.size3d,1.4*this.size3d);this.pointLight=new THREE.PointLight(16777215,1);this.camera.add(this.pointLight);this.pointLight.position.set(this.size3d/2,this.size3d/2,this.size3d/2);var g=new THREE.Vector3(0,0,0.8*this.size3d);this.camera.up=new THREE.Vector3(0,0,1);this.camera.lookAt(g);this.scene.add(this.camera);this.webgl=a.Painter.TestWebGL();this.renderer=this.webgl?new THREE.WebGLRenderer({antialias:true,alpha:true}):new THREE.CanvasRenderer({antialias:true,alpha:true});this.renderer.setSize(this.scene_width,this.scene_height);this.add_3d_canvas(e,this.renderer.domElement);this.DrawXYZ=a.Painter.HPainter_DrawXYZ;this.Render3D=a.Painter.Render3D;this.Resize3D=a.Painter.Resize3D;this.BinHighlight3D=a.Painter.BinHighlight3D;this.first_render_tm=0;this.enable_hightlight=false;this.enable_tooltip=true;this.control=a.Painter.CreateOrbitControl(this,this.camera,this.scene,this.renderer,g);var d=this;this.control.ProcessMouseMove=function(j){var k=null;for(var h=0;h<j.length;++h){if(j[h].object.tooltip){k=j[h].object.tooltip(j[h]);if(k){break}}}if(k!==null){var l=0.0001*d.size3d;if((k.x1>k.x2)||(k.y1>k.y2)||(k.z1>k.z2)){console.warn("check 3D hints coordinates")}k.x1-=l;k.x2+=l;k.y1-=l;k.y2+=l;k.z1-=l;k.z2+=l}d.BinHighlight3D(k);return(d.enable_tooltip&&k&&k.info)?k.info:""};this.control.ProcessMouseLeave=function(){d.BinHighlight3D(null)};this.control.ContextMenu=this.ShowContextMenu.bind(this,"hist")};a.Painter.HPainter_TestAxisVisibility=function(h,m,e,j){var l;for(var d=0;d<m.children.length;++d){l=m.children[d];if(l.axis_draw){break}l=undefined}if(!l){return}if(!h){m.remove(l);delete this.TestAxisVisibility;return}e=e?true:false;j=j?true:false;var i=1,k=h.position;if((k.x<0)&&(k.y>=0)){i=2}if((k.x>=0)&&(k.y>=0)){i=3}if((k.x>=0)&&(k.y<0)){i=4}function f(p,n){if(p<=i){p+=4}return(p>i)&&(p<i+n)}for(var d=0;d<l.children.length;++d){var o=l.children[d];if(o.grid){o.visible=j&&f(o.grid,3)}else{if(o.zid){o.visible=f(o.zid,2)}else{if(o.xyid){o.visible=f(o.xyid,3)}else{if(o.xyboxid){var g=5,c=0;if(j&&!e){g=3;c=-2}else{if(e&&!j){g=3}else{if(!e&&!j){g=(o.bottom?3:0)}}}o.visible=f(o.xyboxid+c,g);if(!o.visible&&o.bottom&&j){o.visible=f(o.xyboxid,3)}}else{if(o.zboxid){var g=2,c=0;if(e&&j){g=5}else{if(j&&!e){g=4}else{if(!j&&e){c=-2;g=4}}}o.visible=f(o.zboxid+c,g)}}}}}}};a.Painter.HPainter_DrawXYZ=function(z,al,B){var H=-this.size3d,g=this.size3d,G=-this.size3d,f=this.size3d,D=0,d=2*this.size3d,Y=Math.round(this.size3d*0.05),A=this.root_pad(),y=this.histo,p=this.xmin,ab=this.xmax,V=this.ymin,h=this.ymax,e=this.zmin,M=this.zmax,r=false,w=false;if(this.size3d===0){H=this.xmin;g=this.xmax;G=this.ymin;f=this.ymax;D=this.zmin;d=this.zmax;Y=(d-D)*0.05}if(("zoom_xmin" in this)&&("zoom_xmax" in this)&&(this.zoom_xmin!==this.zoom_xmax)){p=this.zoom_xmin;ab=this.zoom_xmax}if(("zoom_ymin" in this)&&("zoom_ymax" in this)&&(this.zoom_ymin!==this.zoom_ymax)){V=this.zoom_ymin;h=this.zoom_ymax;r=true}if(("zoom_zmin" in this)&&("zoom_zmax" in this)&&(this.zoom_zmin!==this.zoom_zmax)){e=this.zoom_zmin;M=this.zoom_zmax;w=true}if(al){e=V;M=h;w=r;if(!w){e=this.hmin;M=this.hmax}V=0;h=1}this.lego_zmin=e;this.lego_zmax=M;if((B!==undefined)&&!w){M*=B}this.TestAxisVisibility=a.Painter.HPainter_TestAxisVisibility;if(A&&A.fLogx){if(ab<=0){ab=1}if((p<=0)&&(this.nbinsx>0)){for(var ai=0;ai<this.nbinsx;++ai){p=Math.max(p,this.GetBinX(ai));if(p>0){break}}}if(p<=0){p=0.0001*ab}this.tx=b.scale.log();this.x_kind="log"}else{this.tx=b.scale.linear();if(y&&y.fXaxis.fLabels){this.x_kind="labels"}else{this.x_kind="lin"}}this.tx.domain([p,ab]).range([H,g]);this.x_handle=new a.TAxisPainter(y?y.fXaxis:null);this.x_handle.SetAxisConfig("xaxis",this.x_kind,this.tx,this.xmin,this.xmax,p,ab);this.x_handle.CreateFormatFuncs();if(A&&A.fLogy&&!al){if(h<=0){h=1}if((V<=0)&&(this.nbinsy>0)){for(var ai=0;ai<this.nbinsy;++ai){V=Math.max(V,this.GetBinY(ai));if(V>0){break}}}if(V<=0){V=0.0001*h}this.ty=b.scale.log();this.y_kind="log"}else{this.ty=b.scale.linear();if(y&&y.fYaxis.fLabels){this.y_kind="labels"}else{this.y_kind="lin"}}this.ty.domain([V,h]).range([G,f]);this.y_handle=new a.TAxisPainter(y?y.fYaxis:null);this.y_handle.SetAxisConfig("yaxis",this.y_kind,this.ty,this.ymin,this.ymax,V,h);this.y_handle.CreateFormatFuncs();if(A&&A.fLogz){if(M<=0){M=1}if(e<=0){e=0.0001*M}this.tz=b.scale.log();this.z_kind="log"}else{this.tz=b.scale.linear();this.z_kind="lin"}this.tz.domain([e,M]).range([D,d]);this.z_handle=new a.TAxisPainter(y?y.fZaxis:null);this.z_handle.SetAxisConfig("zaxis",this.z_kind,this.tz,this.zmin,this.zmax,e,M);this.z_handle.CreateFormatFuncs();var x=new THREE.MeshBasicMaterial({color:0}),s=new THREE.LineBasicMaterial({color:0}),Z=Y*0.5,N,c,L=[],I=1,X=this.x_handle.CreateTicks(),k=this.y_handle.CreateTicks(),aa=this.z_handle.CreateTicks();var j=new THREE.Object3D();j.axis_draw=true;z.add(j);var ac=[],ak=0;while(X.next()){var U=X.grpos;var ag=(X.kind===1);var F=this.x_handle.format(X.tick,true,true);if(X.last_major()){F="x"}else{if(F===null){ag=false;F=""}}if(ag&&F&&(F.length>0)){var C=new THREE.TextGeometry(F,{font:a.threejs_font_helvetiker_regular,size:Y,height:0,curveSegments:10});C.computeBoundingBox();var u=C.boundingBox.max.x-C.boundingBox.min.x,t=C.boundingBox.max.y-C.boundingBox.min.y;C.translate(-u/2,0,0);ak=Math.max(ak,t);C.grx=U;L.push(C);if(!X.last_major()){var aj=(X.next_major_grpos()-U);if(u>0){I=Math.min(I,0.9*aj/u)}if(this.x_handle.IsCenterLabels()){C.grx+=aj/2}}}ac.push(U,0,0,U,(ag?-Z:-Z*0.6),0)}var q=new THREE.Geometry(),o=new THREE.Geometry();L.forEach(function(n){var i=new THREE.Matrix4();i.set(I,0,0,n.grx,0,I,0,-ak*I-1.5*Z,0,0,1,0);q.merge(n,i);i.set(-I,0,0,n.grx,0,I,0,-ak*I-1.5*Z,0,0,1,0);o.merge(n,i)});q=new THREE.BufferGeometry().fromGeometry(q);o=new THREE.BufferGeometry().fromGeometry(o);var af=new THREE.BufferGeometry();af.addAttribute("position",new THREE.BufferAttribute(new Float32Array(ac),3));var ad=new THREE.Object3D();ad.position.set(0,G,D);ad.rotation.x=1/4*Math.PI;ad.xyid=2;ad.add(new THREE.LineSegments(af,s));ad.add(new THREE.Mesh(q,x));j.add(ad);ad=new THREE.Object3D();ad.position.set(0,f,D);ad.rotation.x=3/4*Math.PI;ad.add(new THREE.LineSegments(af,s));ad.add(new THREE.Mesh(o,x));ad.xyid=4;j.add(ad);L=[];I=1;ak=0;ac=[];while(k.next()){var T=k.grpos;var ag=(k.kind===1);var F=this.y_handle.format(k.tick,true,true);if(k.last_major()){F="y"}else{if(F===null){ag=false;F=""}}if(ag){var C=new THREE.TextGeometry(F,{font:a.threejs_font_helvetiker_regular,size:Y,height:0,curveSegments:10});C.computeBoundingBox();var u=C.boundingBox.max.x-C.boundingBox.min.x,t=C.boundingBox.max.y-C.boundingBox.min.y;C.translate(-u/2,0,0);ak=Math.max(ak,t);C.gry=T;L.push(C);if(!k.last_major()){var aj=(k.next_major_grpos()-T);if(u>0){I=Math.min(I,0.9*aj/u)}if(this.y_handle.IsCenterLabels()){C.gry+=aj/2}}}ac.push(0,T,0,(ag?-Z:-Z*0.6),T,0)}var q=new THREE.Geometry(),o=new THREE.Geometry();L.forEach(function(n){var i=new THREE.Matrix4();i.set(0,I,0,-ak*I-1.5*Z,-I,0,0,n.gry,0,0,1,0);q.merge(n,i);i.set(0,I,0,-ak*I-1.5*Z,I,0,0,n.gry,0,0,1,0);o.merge(n,i)});q=new THREE.BufferGeometry().fromGeometry(q);o=new THREE.BufferGeometry().fromGeometry(o);var af=new THREE.BufferGeometry();af.addAttribute("position",new THREE.BufferAttribute(new Float32Array(ac),3));if(!al){var O=new THREE.Object3D();O.position.set(H,0,D);O.rotation.y=-1/4*Math.PI;O.add(new THREE.LineSegments(af,s));O.add(new THREE.Mesh(q,x));O.xyid=3;j.add(O);O=new THREE.Object3D();O.position.set(g,0,D);O.rotation.y=-3/4*Math.PI;O.add(new THREE.LineSegments(af,s));O.add(new THREE.Mesh(o,x));O.xyid=1;j.add(O)}L=[];I=1;var ac=[];var K=null,J=null,am=null;if(this.size3d!==0){K=[];J=[]}while(aa.next()){var S=aa.grpos;var ag=aa.kind==1;var F=this.z_handle.format(aa.tick,true,true);if(F===null){ag=false;F=""}if(ag&&F&&(F.length>0)){var C=new THREE.TextGeometry(F,{font:a.threejs_font_helvetiker_regular,size:Y,height:0,curveSegments:10});C.computeBoundingBox();var u=C.boundingBox.max.x-C.boundingBox.min.x,t=C.boundingBox.max.y-C.boundingBox.min.y;C.translate(-u,-t/2,0);C.grz=S;L.push(C);if((am!==null)&&(t>0)){I=Math.min(I,0.9*(S-am)/t)}am=S}if(K&&ag){K.push(H,0,S,g,0,S)}if(J&&ag){J.push(0,G,S,0,f,S)}ac.push(0,0,S,(ag?Z:Z*0.6),0,S)}if(K&&(K.length>0)){var ah=new THREE.LineDashedMaterial({color:0,dashSize:10,gapSize:2});var m=new THREE.BufferGeometry();m.addAttribute("position",new THREE.BufferAttribute(new Float32Array(K),3));var W=new THREE.LineSegments(m,ah);W.position.set(0,f,0);W.grid=2;W.visible=false;j.add(W);W=new THREE.LineSegments(m,ah);W.position.set(0,G,0);W.grid=4;W.visible=false;j.add(W)}if(J&&(J.length>0)){var ah=new THREE.LineDashedMaterial({color:0,dashSize:10,gapSize:2});var m=new THREE.BufferGeometry();m.addAttribute("position",new THREE.BufferAttribute(new Float32Array(J),3));var W=new THREE.LineSegments(m,ah);W.position.set(g,0,0);W.grid=3;W.visible=false;j.add(W);W=new THREE.LineSegments(m,ah);W.position.set(H,0,0);W.grid=1;W.visible=false;j.add(W)}var E=new THREE.Geometry();L.forEach(function(n){var i=new THREE.Matrix4();i.set(-I,0,0,2*Z,0,0,1,0,0,I,0,n.grz);E.merge(n,i)});E=new THREE.BufferGeometry().fromGeometry(E);var af=new THREE.BufferGeometry();af.addAttribute("position",new THREE.BufferAttribute(new Float32Array(ac),3));var v=[];for(var ae=0;ae<4;++ae){v.push(new THREE.Object3D());v[ae].add(new THREE.Mesh(E,x));v[ae].add(new THREE.LineSegments(af,s));v[ae].zid=ae+2;j.add(v[ae])}v[0].position.set(H,f,0);v[0].rotation.z=3/4*Math.PI;v[1].position.set(g,f,0);v[1].rotation.z=1/4*Math.PI;v[2].position.set(g,G,0);v[2].rotation.z=-1/4*Math.PI;v[3].position.set(H,G,0);v[3].rotation.z=-3/4*Math.PI;if(this.size3d===0){return}var R=new THREE.BufferGeometry();R.addAttribute("position",new THREE.BufferAttribute(new Float32Array([H,0,0,g,0,0]),3));for(var ae=0;ae<2;++ae){var l=new THREE.LineSegments(R,s);l.position.set(0,G,(ae===0)?D:d);l.xyboxid=2;l.bottom=(ae==0);j.add(l);l=new THREE.LineSegments(R,s);l.position.set(0,f,(ae===0)?D:d);l.xyboxid=4;l.bottom=(ae==0);j.add(l)}var Q=new THREE.BufferGeometry();Q.addAttribute("position",new THREE.BufferAttribute(new Float32Array([0,G,0,0,f,0]),3));for(var ae=0;ae<2;++ae){var l=new THREE.LineSegments(Q,s);l.position.set(H,0,(ae===0)?D:d);l.xyboxid=3;l.bottom=(ae==0);j.add(l);l=new THREE.LineSegments(Q,s);l.position.set(g,0,(ae===0)?D:d);l.xyboxid=1;l.bottom=(ae==0);j.add(l)}var P=new THREE.BufferGeometry();P.addAttribute("position",new THREE.BufferAttribute(new Float32Array([0,0,D,0,0,d]),3));for(var ae=0;ae<4;++ae){var l=new THREE.LineSegments(P,s);l.zboxid=v[ae].zid;l.position.copy(v[ae].position);j.add(l)}};a.Painter.Box_Vertices=[new THREE.Vector3(1,1,1),new THREE.Vector3(1,1,0),new THREE.Vector3(1,0,1),new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),new THREE.Vector3(0,1,1),new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,1)];a.Painter.Box_Indexes=[0,2,1,2,3,1,4,6,5,6,7,5,4,5,1,5,0,1,7,6,2,6,3,2,5,7,0,7,2,0,1,3,4,3,6,4];a.Painter.Box_Normals=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1];a.Painter.Box_Segments=[0,2,2,7,7,5,5,0,1,3,3,6,6,4,4,1,1,0,3,2,6,7,4,5];a.Painter.Box_MeshSegments=(function(){var c=new Int32Array(a.Painter.Box_Segments.length);for(var e=0;e<c.length;++e){for(var d=0;d<a.Painter.Box_Indexes.length;++d){if(a.Painter.Box_Segments[e]===a.Painter.Box_Indexes[d]){c[e]=d;break}}}return c})();a.Painter.BinHighlight3D=function(n){if(!n||(n.x1===undefined)||!this.enable_hightlight||!this.enable_tooltip){if(this.tooltip_mesh){this.toplevel.remove(this.tooltip_mesh);delete this.tooltip_mesh;this.Render3D()}this.ProvideUserTooltip(null);return}var f=a.Painter.Box_Indexes,m=a.Painter.Box_Normals,i=a.Painter.Box_Vertices,j,c;var g=new THREE.Color(n.color?n.color:16711680);if(this.tooltip_mesh===undefined){j=new Float32Array(f.length*3);c=new Float32Array(f.length*3);var l=new THREE.BufferGeometry();l.addAttribute("position",new THREE.BufferAttribute(j,3));l.addAttribute("normal",new THREE.BufferAttribute(c,3));var e=new THREE.MeshBasicMaterial({color:g,shading:THREE.SmoothShading});this.tooltip_mesh=new THREE.Mesh(l,e);this.toplevel.add(this.tooltip_mesh)}else{j=this.tooltip_mesh.geometry.attributes.position.array;this.tooltip_mesh.geometry.attributes.position.needsUpdate=true;this.tooltip_mesh.material.color=g}if(n.x1===n.x2){console.warn("same tip X",n.x1,n.x2)}if(n.y1===n.y2){console.warn("same tip Y",n.y1,n.y2)}if(n.z1===n.z2){n.z2=n.z1+0.0001}for(var d=0,o=-3;d<f.length;++d){var h=i[f[d]];j[d*3]=n.x1+h.x*(n.x2-n.x1);j[d*3+1]=n.y1+h.y*(n.y2-n.y1);j[d*3+2]=n.z1+h.z*(n.z2-n.z1);if(c){if(d%6===0){o+=3}c[d*3]=m[o];c[d*3+1]=m[o+1];c[d*3+2]=m[o+2]}}this.Render3D();if(this.IsUserTooltipCallback()&&this.GetObject()){this.ProvideUserTooltip({obj:this.GetObject(),name:this.GetObject().fName,bin:n.bin,cont:n.value,binx:n.ix,biny:n.iy,binz:n.iz,grx:(n.x1+n.x2)/2,gry:(n.y1+n.y2)/2,grz:(n.z1+n.z2)/2})}};a.Painter.HistPainter_DrawLego=function(){var V=a.Painter.Box_Vertices;var H=a.Painter.Box_Indexes;var aC=a.Painter.Box_Normals;var av=a.Painter.Box_Segments;var A=[0,1,1,2,2,3,3,0];var aD=[];aD.push(new THREE.Vector3(0,0,0));aD.push(new THREE.Vector3(0,1,0));aD.push(new THREE.Vector3(1,1,0));aD.push(new THREE.Vector3(1,0,0));var ax=this.tz.domain()[0],q=this.tz.domain()[1];var ar=!this.options.Zero||(ax>0),aB=this.Dimension();var ad=this.GetSelectIndex("x","left",0),ac=this.GetSelectIndex("x","right",1),T=(aB===1)?0:this.GetSelectIndex("y","left",0),S=(aB===1)?1:this.GetSelectIndex("y","right",1),L,K,x,w,l,h,aj,Z,ae,at,r=this.main_painter(),U=(this.options.Lego===11)||(this.options.Lego===13);var ap=new Float32Array(ac+1),ah=new Float32Array(S+1);for(L=ad;L<=ac;++L){x=this.GetBinX(L);if(r.logx&&(x<=0)){ad=L+1;continue}ap[L]=this.tx(x);if(ap[L]<-1.001*this.size3d){ad=L+1}if(ap[L]>1.001*this.size3d){ac=L-1}}if(aB===1){ah[0]=this.ty(0);ah[1]=this.ty(1)}else{for(K=T;K<=S;++K){l=this.GetBinY(K);if(r.logy&&(l<=0)){T=K+1;continue}ah[K]=this.ty(l);if(ah[K]<-1.001*this.size3d){T=K+1}if(ah[K]>1.001*this.size3d){S=K-1}}}if((ad>=ac)||(T>=S)){return}var E=(this.histo.getBin(ac,S)<65535);var Y=[ax,q],M=null,am=0;if((this.options.Lego===12)||(this.options.Lego===14)){var d=20;if(this.histo.fContour!=null){d=this.histo.fContour.length}Y=this.CreateContour(d,this.lego_zmin,this.lego_zmax);M=this.GetPalette()}for(var ak=0;ak<Y.length-1;++ak){var p=Y[ak],F=Y[ak+1],ay=this.tz(p),aw=0,ag=this.tz(F),c=0,t=0;for(L=ad;L<ac;++L){for(K=T;K<S;++K){aj=this.histo.getBinContent(L+1,K+1);if(aj<p){continue}Z=(aj===p);if(Z&&((ak>0)||!ar)){continue}ae=!Z&&(ak>0);at=!Z&&(aj>F)&&(ak<Y.length-2);c+=(Z?12:H.length);if(ae){c-=6}if(at){c-=6}if(U&&!Z){c-=12;t+=12}}}am+=c+t;var m=new Float32Array(c*3),au=new Float32Array(c*3),aa=E?new Uint16Array(c):new Uint32Array(c),P=null,ab=null,s=null,C=0,X=0,an,y,J,W;if(t>0){P=new Float32Array(t*3);ab=new Float32Array(t*3);s=E?new Uint16Array(t):new Uint32Array(t)}for(L=ad;L<ac;++L){x=ap[L];w=ap[L+1];for(K=T;K<S;++K){aj=this.histo.getBinContent(L+1,K+1);if(aj<p){continue}Z=(aj===p);if(Z&&((ak>0)||!ar)){continue}ae=!Z&&(ak>0);at=!Z&&(aj>F)&&(ak<Y.length-2);l=ah[K];h=ah[K+1];aw=(aj>F)?ag:this.tz(aj);W=0;J=0;if(Z){W+=12;J+=24}var D=H.length,e=this.histo.getBin(L+1,K+1);if(ae){D-=6}while(J<D){an=V[H[J]];if(U&&(J<12)){P[X]=x+an.x*(w-x);P[X+1]=l+an.y*(h-l);P[X+2]=ay+an.z*(aw-ay);ab[X]=aC[W];ab[X+1]=aC[W+1];ab[X+2]=aC[W+2];s[X/3]=e;X+=3}else{m[C]=x+an.x*(w-x);m[C+1]=l+an.y*(h-l);m[C+2]=ay+an.z*(aw-ay);au[C]=aC[W];au[C+1]=aC[W+1];au[C+2]=aC[W+2];aa[C/3]=e;C+=3}++J;if(J%6===0){W+=3;if(at&&(J===H.length-12)){J+=6;W+=3}}}}}var af=new THREE.BufferGeometry();af.addAttribute("position",new THREE.BufferAttribute(m,3));af.addAttribute("normal",new THREE.BufferAttribute(au,3));var ai=this.GetObject().fFillColor,o=a.Painter.root_colors[ai];if(M){var I=Math.floor((ak+0.99)*M.length/(Y.length-1));if(I>M.length-1){I=M.length-1}o=M[I]}var aA=new THREE.MeshBasicMaterial({color:o,shading:THREE.SmoothShading});var O=new THREE.Mesh(af,aA);O.bins_index=aa;O.painter=this;O.zmin=ax;O.zmax=q;O.tip_color=(ai===3)?16711680:65280;O.tooltip=function(i){if((i.index<0)||(i.index>=this.bins_index.length)){return null}var k=this.painter,j=k.Get3DToolTip(this.bins_index[i.index]);j.x1=k.tx(k.GetBinX(j.ix-1));j.x2=k.tx(k.GetBinX(j.ix));if(k.Dimension()===1){j.y1=k.ty(0);j.y2=k.ty(1)}else{j.y1=k.ty(k.GetBinY(j.iy-1));j.y2=k.ty(k.GetBinY(j.iy))}j.z1=k.tz(this.zmin);j.z2=k.tz(this.zmax);if(j.value<this.zmin){j.z2=j.z1}else{if(j.value<this.zmax){j.z2=k.tz(j.value)}}j.color=this.tip_color;return j};this.toplevel.add(O);if(t>0){var al=new THREE.BufferGeometry();al.addAttribute("position",new THREE.BufferAttribute(P,3));al.addAttribute("normal",new THREE.BufferAttribute(ab,3));var ao=new THREE.MeshBasicMaterial({color:16711680,shading:THREE.SmoothShading});var z=new THREE.Mesh(al,ao);z.bins_index=s;z.painter=this;z.tooltip=O.tooltip;z.zmin=O.zmin;z.zmax=O.zmax;z.tip_color=O.tip_color;this.toplevel.add(z)}}if(this.options.Lego>12){return}var az=0,B=0,R=true;for(L=ad;L<ac;++L){for(K=T;K<S;++K){aj=this.histo.getBinContent(L+1,K+1);if(aj<ax){continue}Z=(aj==ax);if(Z&&!ar){continue}az+=(Z?aD.length:V.length);B+=(Z?A.length:av.length)}}if(az>65520){R=false}if(!R){az=B*3}var u=new Float32Array(az*3),f=R?new Uint16Array(B):null;var ay=this.tz(ax),ag=this.tz(q),aw=0,aq=0,G=0;for(L=ad;L<ac;++L){x=ap[L];w=ap[L+1];for(K=T;K<S;++K){aj=this.histo.getBinContent(L+1,K+1);if(aj<ax){continue}Z=(aj==ax);if(Z&&!ar){continue}l=ah[K];h=ah[K+1];aw=(aj>F)?ag:this.tz(aj);var N=Z?A:av,Q=Z?aD:V;if(R){for(J=0;J<N.length;++J){f[G++]=aq/3+N[J]}for(J=0;J<Q.length;++J){an=Q[J];u[aq]=x+an.x*(w-x);u[aq+1]=l+an.y*(h-l);u[aq+2]=ay+an.z*(aw-ay);aq+=3}}else{for(J=0;J<N.length;++J){an=Q[N[J]];u[aq]=x+an.x*(w-x);u[aq+1]=l+an.y*(h-l);u[aq+2]=ay+an.z*(aw-ay);aq+=3}}}}af=new THREE.BufferGeometry();af.addAttribute("position",new THREE.BufferAttribute(u,3));if(R){af.setIndex(new THREE.BufferAttribute(f,1))}var g=a.Painter.root_colors[this.GetObject().fLineColor];aA=new THREE.LineBasicMaterial({color:new THREE.Color(g)});if(!a.browser.isIE){aA.linewidth=this.GetObject().fLineWidth}var n=new THREE.LineSegments(af,aA);this.toplevel.add(n)};a.Painter.Render3D=function(e){if(e===undefined){e=5}if(e<=0){if("render_tmout" in this){clearTimeout(this.render_tmout)}if(this.renderer===undefined){return}var d=new Date();if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(this.camera,this.toplevel,this.options.FrontBox,this.options.BackBox)}this.renderer.render(this.scene,this.camera);var c=new Date();delete this.render_tmout;if(this.first_render_tm===0){this.first_render_tm=c.getTime()-d.getTime();this.enable_hightlight=this.first_render_tm<1200;console.log("First render tm = "+this.first_render_tm)}return}if("render_tmout" in this){return}this.render_tmout=setTimeout(this.Render3D.bind(this,0),e)};a.Painter.Resize3D=function(){var c=this.size_for_3d(this.access_3d_kind());this.apply_3d_size(c);if((this.scene_width===c.width)&&(this.scene_height===c.height)){return}if((c.width<10)||(c.height<10)){return}this.scene_width=c.width;this.scene_height=c.height;this.camera.aspect=this.scene_width/this.scene_height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.scene_width,this.scene_height);this.Render3D()};a.Painter.TH1Painter_Draw3D=function(d,c){if(c){this.Resize3D()}else{this.Create3DScene();this.Draw3DBins=a.Painter.HistPainter_DrawLego;this.DeleteAtt();this.DrawXYZ(this.toplevel,true,1.1);this.Draw3DBins();this.Render3D()}this.DrawColorPalette((this.options.Zscale>0)&&((this.options.Lego===12)||(this.options.Lego===14)));this.DrawTitle();a.CallBack(d)};a.Painter.TH2Painter_Draw3D=function(d,c){if(c){this.Resize3D()}else{this.Create3DScene();this.Draw3DBins=a.Painter.HistPainter_DrawLego;var e=this.root_pad();this.zmin=e.fLogz?this.gmin0bin*0.3:this.gminbin;this.zmax=this.gmaxbin;if(this.histo.fMinimum!==-1111){this.zmin=this.histo.fMinimum}if(this.histo.fMaximum!==-1111){this.zmax=this.histo.fMaximum}if(e.fLogz&&(this.zmin<=0)){this.zmin=this.zmax*0.00001}this.DeleteAtt();this.DrawXYZ(this.toplevel,false,1.1);this.Draw3DBins();this.Render3D()}this.DrawColorPalette((this.options.Zscale>0)&&((this.options.Lego===12)||(this.options.Lego===14)));this.DrawTitle();a.CallBack(d)};a.TH3Painter=function(c){a.THistPainter.call(this,c);this.Create3DScene=a.Painter.HPainter_Create3DScene};a.TH3Painter.prototype=Object.create(a.THistPainter.prototype);a.TH3Painter.prototype.ScanContent=function(){var d=this.GetObject();this.nbinsx=d.fXaxis.fNbins;this.nbinsy=d.fYaxis.fNbins;this.nbinsz=d.fZaxis.fNbins;this.xmin=d.fXaxis.fXmin;this.xmax=d.fXaxis.fXmax;this.ymin=d.fYaxis.fXmin;this.ymax=d.fYaxis.fXmax;this.zmin=d.fZaxis.fXmin;this.zmax=d.fZaxis.fXmax;this.gminbin=this.gmaxbin=d.getBinContent(1,1,1);var f,e,c;for(f=0;f<this.nbinsx;++f){for(e=0;e<this.nbinsy;++e){for(c=0;c<this.nbinsz;++c){var g=d.getBinContent(f+1,e+1,c+1);if(g<this.gminbin){this.gminbin=g}else{if(g>this.gmaxbin){this.gmaxbin=g}}}}}this.draw_content=this.gmaxbin>0;this.CreateAxisFuncs(true,true)};a.TH3Painter.prototype.CountStat=function(){var q=this.GetObject(),i=0,p=0,w=0,f=0,m=0,u=0,e=0,v=this.GetSelectIndex("x","left"),t=this.GetSelectIndex("x","right"),d=this.GetSelectIndex("y","left"),c=this.GetSelectIndex("y","right"),o=this.GetSelectIndex("z","left"),l=this.GetSelectIndex("z","right"),A={entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0};for(var s=0;s<this.nbinsx+2;++s){var k=this.GetBinX(s-0.5);var h=(s<v)?0:(s>t?2:1);for(var z=0;z<this.nbinsy+2;++z){var r=this.GetBinY(z-0.5);var x=(z<d)?0:(z>c?2:1);for(var j=0;j<this.nbinsz+2;++j){var y=this.GetBinZ(j-0.5);var n=(j<o)?0:(j>l?2:1);var g=q.getBinContent(s,z,j);A.entries+=g;if((h==1)&&(x==1)&&(n==1)){i+=g;p+=k*g;w+=r*g;f+=y*g;m+=k*k*g;u+=r*r*g;e+=y*y*g}}}}if(q.fTsumw>0){i=q.fTsumw;p=q.fTsumwx;m=q.fTsumwx2;w=q.fTsumwy;u=q.fTsumwy2;f=q.fTsumwz;e=q.fTsumwz2}if(i>0){A.meanx=p/i;A.meany=w/i;A.meanz=f/i;A.rmsx=Math.sqrt(m/i-A.meanx*A.meanx);A.rmsy=Math.sqrt(u/i-A.meany*A.meany);A.rmsz=Math.sqrt(e/i-A.meanz*A.meanz)}A.integral=i;if(q.fEntries>1){A.entries=q.fEntries}return A};a.TH3Painter.prototype.FillStatistic=function(g,i,p){if(this.GetObject()===null){return false}var h=g.GetObject(),f=this.CountStat(),k=i%10,n=Math.floor(i/10)%10,j=Math.floor(i/100)%10,m=Math.floor(i/1000)%10,c=Math.floor(i/10000)%10,d=Math.floor(i/100000)%10,e=Math.floor(i/1000000)%10;if(k>0){h.AddText(this.GetObject().fName)}if(n>0){h.AddText("Entries = "+g.Format(f.entries,"entries"))}if(j>0){h.AddText("Mean x = "+g.Format(f.meanx));h.AddText("Mean y = "+g.Format(f.meany));h.AddText("Mean z = "+g.Format(f.meanz))}if(m>0){h.AddText("Std Dev x = "+g.Format(f.rmsx));h.AddText("Std Dev y = "+g.Format(f.rmsy));h.AddText("Std Dev z = "+g.Format(f.rmsz))}if(e>0){h.AddText("Integral = "+g.Format(f.integral,"entries"))}var l=h.fLines.arr.length,o=l*a.gStyle.StatFontSize;if(o<=0||3==(a.gStyle.StatFont%10)){o=0.25*l*a.gStyle.StatH;h.fY1NDC=0.93-o;h.fY2NDC=0.93}return true};a.TH3Painter.prototype.GetBinTips=function(e,c,f){var d=[];d.push(this.GetTipName());d.push("x="+a.FFormat(this.GetBinX(e+0.5),"6.4g")+" bin="+(e+1));d.push("y="+a.FFormat(this.GetBinY(c+0.5),"6.4g")+" bin="+(c+1));d.push("z="+a.FFormat(this.GetBinZ(f+0.5),"6.4g")+" bin="+(f+1));d.push("entries="+a.FFormat(this.GetObject().getBinContent(e+1,c+1,f+1),"7.0g"));return d};a.TH3Painter.prototype.Draw3DBins=function(){if(!this.draw_content){return}var af=this.GetObject().fFillColor,q=a.Painter.root_colors[af],W=null,S=0,r=null,d=0,A,ag;if(this.options.Box===11){W=new THREE.MeshLambertMaterial({color:q});var p=a.Painter.TestWebGL()?new THREE.SphereGeometry(0.5,16,12):new THREE.SphereGeometry(0.5,8,6);p.applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI/2));S=p.faces.length*9;A=new Float32Array(S);ag=new Float32Array(S);for(var s=0;s<p.faces.length;++s){A[9*s]=p.vertices[p.faces[s].a].x;A[9*s+1]=p.vertices[p.faces[s].a].y;A[9*s+2]=p.vertices[p.faces[s].a].z;A[9*s+3]=p.vertices[p.faces[s].b].x;A[9*s+4]=p.vertices[p.faces[s].b].y;A[9*s+5]=p.vertices[p.faces[s].b].z;A[9*s+6]=p.vertices[p.faces[s].c].x;A[9*s+7]=p.vertices[p.faces[s].c].y;A[9*s+8]=p.vertices[p.faces[s].c].z;ag[9*s]=p.faces[s].vertexNormals[0].x;ag[9*s+1]=p.faces[s].vertexNormals[0].y;ag[9*s+2]=p.faces[s].vertexNormals[0].z;ag[9*s+3]=p.faces[s].vertexNormals[1].x;ag[9*s+4]=p.faces[s].vertexNormals[1].y;ag[9*s+5]=p.faces[s].vertexNormals[1].z;ag[9*s+6]=p.faces[s].vertexNormals[2].x;ag[9*s+7]=p.faces[s].vertexNormals[2].y;ag[9*s+8]=p.faces[s].vertexNormals[2].z}}else{W=new THREE.MeshBasicMaterial({color:q});var N=a.Painter.Box_Indexes,C=a.Painter.Box_Normals,c=a.Painter.Box_Vertices;S=N.length*3;A=new Float32Array(S);ag=new Float32Array(S);for(var X=0,ah=-3;X<N.length;++X){var w=c[N[X]];A[X*3]=w.x-0.5;A[X*3+1]=w.y-0.5;A[X*3+2]=w.z-0.5;if(X%6===0){ah+=3}ag[X*3]=C[ah];ag[X*3+1]=C[ah+1];ag[X*3+2]=C[ah+2]}d=1}var v=this.GetObject(),o=this.GetSelectIndex("x","left",0),m=this.GetSelectIndex("x","right",0),ac=this.GetSelectIndex("y","left",0),Z=this.GetSelectIndex("y","right",0),H=this.GetSelectIndex("z","left",0),G=this.GetSelectIndex("z","right",0),t=this.GetTipName("<br/>");var z=(this.tx(this.GetBinX(m+0.5))-this.tx(this.GetBinX(o+0.5)))/(m-o),y=(this.ty(this.GetBinY(Z+0.5))-this.ty(this.GetBinY(ac+0.5)))/(Z-ac),x=(this.tz(this.GetBinZ(G+0.5))-this.tz(this.GetBinZ(H+0.5)))/(G-H);var V=0,ab,Y,X,g,e;for(ab=o;ab<m;++ab){for(Y=ac;Y<Z;++Y){for(X=H;X<G;++X){e=v.getBinContent(ab+1,Y+1,X+1);if(e<=this.gminbin){continue}g=(this.options.Color>0)?1:e/this.gmaxbin;if(g<0.00001){continue}V++}}}if((d===1)&&(V*S/3>65520)){d=2}var h=new Float32Array(V*S),O=new Float32Array(V*S),P=new Int32Array(V),T,R,l;if(d===1){T=a.Painter.Box_MeshSegments;R=new Uint16Array(V*T.length)}if(d===2){T=a.Painter.Box_Segments;l=new Float32Array(V*T.length*3)}var ae,L,ad,K,aa,J;V=0;for(ab=o;ab<m;++ab){ae=this.GetBinX(ab+0.5);L=this.tx(ae);for(Y=ac;Y<Z;++Y){ad=this.GetBinY(Y+0.5);K=this.ty(ad);for(X=H;X<G;++X){e=v.getBinContent(ab+1,Y+1,X+1);if(e<=this.gminbin){continue}g=e/this.gmaxbin;if(g<0.00001){continue}aa=this.GetBinZ(X+0.5);J=this.tz(aa);P[V]=v.getBin(ab+1,Y+1,X+1);var I=V*S;for(var B=0;B<S;B+=3,I+=3){h[I]=L+A[B]*z*g;h[I+1]=K+A[B+1]*y*g;h[I+2]=J+A[B+2]*x*g;O[I]=ag[B];O[I+1]=ag[B+1];O[I+2]=ag[B+2]}if(d===1){I=V*T.length;var F=Math.round(V*S/3);for(var U=0;U<T.length;++U){R[I+U]=F+T[U]}}if(d===2){I=V*T.length*3;for(var U=0;U<T.length;++U,I+=3){var w=a.Painter.Box_Vertices[T[U]];l[I]=L+(w.x-0.5)*z*g;l[I+1]=K+(w.y-0.5)*y*g;l[I+2]=J+(w.z-0.5)*x*g}}V++}}}var f=new THREE.BufferGeometry();f.addAttribute("position",new THREE.BufferAttribute(h,3));f.addAttribute("normal",new THREE.BufferAttribute(O,3));var u=new THREE.Mesh(f,W);u.bins=P;u.bins_faces=S/3;u.painter=this;var Q=(this.options.Box===11)?0.4:0.5;u.scalex=Q*z;u.scaley=Q*y;u.scalez=Q*x;u.tip_color=(af===3)?16711680:65280;u.tooltip=function(i){var j=Math.floor(i.index/this.bins_faces);if((j<0)||(j>=this.bins.length)){return null}var n=this.painter,k=n.Get3DToolTip(this.bins[j]);L=n.tx(n.GetBinX(k.ix-0.5));K=n.ty(n.GetBinY(k.iy-0.5));J=n.tz(n.GetBinZ(k.iz-0.5));g=k.value/n.gmaxbin;k.x1=L-this.scalex*g;k.x2=L+this.scalex*g;k.y1=K-this.scaley*g;k.y2=K+this.scaley*g;k.z1=J-this.scalez*g;k.z2=J+this.scalez*g;k.color=this.tip_color;return k};this.toplevel.add(u);if(d>0){var E=new THREE.BufferGeometry();if(d===1){E.setIndex(new THREE.BufferAttribute(R,1));E.addAttribute("position",new THREE.BufferAttribute(h,3))}else{E.addAttribute("position",new THREE.BufferAttribute(l,3))}var D=new THREE.LineBasicMaterial({color:0});var M=new THREE.LineSegments(E,D);this.toplevel.add(M)}};a.TH3Painter.prototype.Redraw=function(c){if(c){this.Resize3D()}else{this.Create3DScene();this.DrawXYZ(this.toplevel);this.Draw3DBins();this.Render3D()}};a.TH3Painter.prototype.FillToolbar=function(){var c=this.pad_painter(true);if(c===null){return}c.AddButton(a.ToolbarIcons.undo,"Unzoom all axes","UnzoomAllAxis");if(this.draw_content){c.AddButton(a.ToolbarIcons.statbox,"Toggle stat box","ToggleStatBox")}};a.TH3Painter.prototype.FillHistContextMenu=function(c){c.addDrawMenu("Draw with",["box","box1"],function(d){this.options=this.DecodeOptions(d);this.Redraw()})};a.Painter.drawHistogram3D=function(f,c,e){a.extend(this,new a.TH3Painter(c));this.SetDivId(f,4);this.options=this.DecodeOptions(e);this.CheckPadRange();this.ScanContent();this.Redraw();this.DrawTitle();if(a.gStyle.AutoStat&&this.create_canvas){var d=this.CreateStat();if(d){a.draw(this.divid,d,"")}}this.FillToolbar();return this.DrawingReady()};a.Painter.drawPolyMarker3D=function(j,l,d){this.SetDivId(j);var p=this.main_painter();if(!p||!("renderer" in p)){return this.DrawingReady()}var q=3,v=p.webgl?50000:5000;if((a.gStyle.OptimizeDraw>0)&&(l.fP.length>3*v)){q=Math.floor(l.fP.length/v/3)*3;if(q<=6){q=6}}var w=Math.floor(l.fP.length/q),e=a.Painter.Box_Indexes,A=a.Painter.Box_Normals,o=a.Painter.Box_Vertices,n=new Float32Array(e.length*3*w),m=new Float32Array(e.length*3*w),h=0,F=p.size3d/100;for(var D=0;D<w*q;D+=q){var t=p.tx(l.fP[D]),s=p.ty(l.fP[D+1]),r=p.tz(l.fP[D+2]);for(var C=0,f=-3;C<e.length;++C){var E=o[e[C]];n[h]=t+(E.x-0.5)*F;n[h+1]=s+(E.y-0.5)*F;n[h+2]=r+(E.z-0.5)*F;if(C%6===0){f+=3}m[h]=A[f];m[h+1]=A[f+1];m[h+2]=A[f+2];h+=3}}var B=new THREE.BufferGeometry();B.addAttribute("position",new THREE.BufferAttribute(n,3));B.addAttribute("normal",new THREE.BufferAttribute(m,3));var g=a.Painter.root_colors[l.fMarkerColor];var u=new THREE.MeshBasicMaterial({color:g,shading:THREE.SmoothShading});var c=new THREE.Mesh(B,u);p.toplevel.add(c);c.step=q;c.nvertex=e.length;c.poly=l;c.painter=p;c.scale0=0.7*F;c.tip_color=(l.fMarkerColor===3)?16711680:65280;c.tooltip=function(i){var z=Math.floor(i.index/this.nvertex)*this.step;if((z<0)||(z>=this.poly.fP.length)){return null}var H=this.painter;var G={info:"bin: "+z/3+"<br/>x: "+H.x_handle.format(this.poly.fP[z])+"<br/>y: "+H.y_handle.format(this.poly.fP[z+1])+"<br/>z: "+H.z_handle.format(this.poly.fP[z+2])};var y=H.tx(this.poly.fP[z]),x=H.ty(this.poly.fP[z+1]),k=H.tz(this.poly.fP[z+2]);G.x1=y-this.scale0;G.x2=y+this.scale0;G.y1=x-this.scale0;G.y2=x+this.scale0;G.z1=k-this.scale0;G.z2=k+this.scale0;G.color=this.tip_color;return G};p.Render3D(100);return this.DrawingReady()};return a.Painter}));