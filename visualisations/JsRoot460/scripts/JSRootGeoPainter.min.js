(function(a){if(typeof define==="function"&&define.amd){define(["d3","JSRootPainter","JSRoot3DPainter","JSRootGeoBase"],a)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootGeoPainter.js")}if(typeof JSROOT.Painter!="object"){throw new Error("JSROOT.Painter is not defined","JSRootGeoPainter.js")}if(typeof d3=="undefined"){throw new Error("d3 is not defined","JSRootGeoPainter.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRootGeoPainter.js")}a(d3,JSROOT)}}(function(b,a){if(typeof define==="function"&&define.amd){a.loadScript("$$$style/JSRootGeoPainter.css")}if(typeof a.GEO!=="object"){console.error("JSROOT.GEO namespace is not defined")}a.TGeoPainter=function(c){if(c&&(c._typename.indexOf("TGeoVolume")===0)){c={_typename:"TGeoNode",fVolume:c,fName:c.fName,_geoh:c._geoh}}a.TObjectPainter.call(this,c);this.no_default_title=true;this.Cleanup(true)};a.TGeoPainter.prototype=Object.create(a.TObjectPainter.prototype);a.TGeoPainter.prototype.CreateToolbar=function(d){if(this._toolbar){return}var c=this;var e=[{name:"toImage",title:"Save as PNG",icon:a.ToolbarIcons.camera,click:function(){var g=c._renderer.domElement.toDataURL("image/png");g.replace("image/png","image/octet-stream");var f=document.createElement("a");if(typeof f.download==="string"){document.body.appendChild(f);f.download="geometry.png";f.href=g;f.click();document.body.removeChild(f)}}}];if(a.hpainter&&a.hpainter.nobrowser){e.push({name:"browser",title:"Show hierarchy browser",icon:a.ToolbarIcons.arrow_right,click:function(){if(a.hpainter){a.hpainter.ToggleFloatBrowser()}}})}if(a.gStyle.ContextMenu){e.push({name:"menu",title:"Show context menu",icon:a.ToolbarIcons.question,click:function(){var f=b.event;b.event.preventDefault();b.event.stopPropagation();a.Painter.createMenu(function(g){g.painter=c;c.FillContextMenu(g);g.show(f)})}})}this._toolbar=new a.Toolbar(this.select_main(),[e])};a.TGeoPainter.prototype.ModifyVisisbility=function(d,c){var f=this.GetObject();var e=a.GEO.NodeKind(f);var j=a.GEO.getNodeProperties(e,f);if(d==""){return a.GEO.SetBit(j.volume,a.GEO.BITS.kVisThis,(c==="+"))}var h;if(d.indexOf("*")<0){h=new RegExp(d)}else{h=new RegExp("^"+d.split("*").join(".*")+"$")}if(j.chlds!==null){for(var i=0;i<j.chlds.length;++i){var g=a.GEO.getNodeProperties(e,j.chlds[i]);if(h.test(g.name)&&g.volume){a.GEO.SetBit(g.volume,a.GEO.BITS.kVisThis,(c==="+"));a.GEO.SetBit(g.volume,a.GEO.BITS.kVisDaughters,(c==="+"))}}}};a.TGeoPainter.prototype.decodeOptions=function(e){var k={_grid:false,_bound:false,_debug:false,_full:false,_axis:false,_count:false,wireframe:false,scale:new THREE.Vector3(1,1,1),more:1,use_worker:false,update_browser:true,show_controls:false,highlight:false,select_in_view:false,clipx:false,clipy:false,clipz:false};var i=a.GetUrlOption("_grid");if(i!==null&&i=="true"){k._grid=true}var i=a.GetUrlOption("_debug");if(i!==null&&i=="true"){k._debug=true;k._grid=true}if(i!==null&&i=="bound"){k._debug=true;k._grid=true;k._bound=true}if(i!==null&&i=="full"){k._debug=true;k._grid=true;k._full=true;k._bound=true}while(true){var f=e.indexOf("+"),h=e.indexOf("-");if((f<0)&&(h<0)){break}var m=f,g="+";if((m<0)||((h>=0)&&(h<f))){m=h;g="-"}var l=m+1,j=new RegExp("[,; .]");while((l<e.length)&&!j.test(e[l])&&(e[l]!="+")&&(e[l]!="-")){l++}var c=e.substring(m+1,l);e=e.substr(0,m)+e.substr(l);this.ModifyVisisbility(c,g)}e=e.toLowerCase();function d(n){if(e.indexOf(n)<0){return false}e=e.replace(n," ");return true}if(d("more3")){k.more=3}if(d("more")){k.more=2}if(d("all")){k.more=100}if(d("invx")||d("invertx")){k.scale.x=-1}if(d("controls")||d("ctrl")){k.show_controls=true}if(d("clipxyz")){k.clipx=k.clipy=k.clipz=true}if(d("clipx")){k.clipx=true}if(d("clipy")){k.clipy=true}if(d("clipz")){k.clipz=true}if(d("clip")){k.clipx=k.clipy=k.clipz=true}if(d("noworker")){k.use_worker=-1}if(d("worker")){k.use_worker=1}if(d("highlight")){k.highlight=true}if(d("wire")){k.wireframe=true}if(d("invy")){k.scale.y=-1}if(d("invz")){k.scale.z=-1}if(d("count")){k._count=true}if(d("axis")||d("a")){k._axis=true;k._yup=false}if(d("d")){k._debug=true}if(d("g")){k._grid=true}if(d("b")){k._bound=true}if(d("w")){k.wireframe=true}if(d("f")){k._full=true}if(d("y")){k._yup=true}if(d("z")){k._yup=false}return k};a.TGeoPainter.prototype.ActiavteInBrowser=function(d,c){if(this.GetItemName()===null){return}if(typeof d=="string"){d=[d]}if(this.GetItemName().length>0){for(var e=0;e<d.length;++e){d[e]=this.GetItemName()+((d[e].length>0)?("/"+d[e]):"")}}if(a.hpainter){if(a.hpainter.nobrowser&&c){a.hpainter.ToggleFloatBrowser(true)}a.hpainter.actiavte(d,c);if(!this.options.update_browser){setTimeout(function(){a.hpainter.actiavte([])},2000)}}};a.TGeoPainter.prototype.TestMatrixes=function(){var e=this,g=0,d=0,h=0;var c={domatrix:true,func:function(j){var p=this.getmatrix();var o=this.CopyStack();var r=e._clones.CreateObject3D(o.stack,e._toplevel,"mesh");if(!r){return true}d++;var q=r.matrixWorld,m,i;if(q.equals(p)){return true}if((q.determinant()>0)&&(p.determinant()<-0.9)){m=THREE.Vector3(1,1,-1);i=p;p=p.clone().scale(m);if(q.equals(p)){return true}}var n=0;for(var l=0;l<16;++l){n=Math.max(n,Math.abs(q.elements[l]-p.elements[l]))}h=Math.max(n,h);if(n<0.0001){return true}console.log(e._clones.ResolveStack(o.stack).name,"maxdiff",n,"determ",q.determinant(),p.determinant());g++;return false}};tm1=new Date().getTime();var f=this._clones.ScanVisible(c);tm2=new Date().getTime();console.log("Compare matrixes total",d,"errors",g,"takes",tm2-tm1,"maxdiff",h)};a.TGeoPainter.prototype.FillContextMenu=function(c){c.add("header: Draw options");c.addchk(this.options.update_browser,"Browser update",function(){this.options.update_browser=!this.options.update_browser;if(!this.options.update_browser){this.ActiavteInBrowser([])}});c.addchk(this.options.show_controls,"Show Controls",function(){this.options.show_controls=!this.options.show_controls;this.showControlOptions(this.options.show_controls)});c.addchk(this.TestAxisVisibility,"Show axes",function(){this.toggleAxisDraw()});c.addchk(this.options.wireframe,"Wire frame",function(){this.options.wireframe=!this.options.wireframe;this.changeWireFrame(this._scene,this.options.wireframe)});c.addchk(this.options.highlight,"Highlight volumes",function(){this.options.highlight=!this.options.highlight});c.addchk(this.options.wireframe,"Reset camera position",function(){this.focusCamera();this.Render3D()});c.addchk(this._controls.autoRotate,"Autorotate",function(){this._controls.autoRotate=!this._controls.autoRotate;this.autorotate(2.5)});c.addchk(this.options.select_in_view,"Select in view",function(){this.options.select_in_view=!this.options.select_in_view;if(this.options.select_in_view){this.startDrawGeometry()}})};a.TGeoPainter.prototype.showControlOptions=function(g){if(this._datgui){if(g){return}this._datgui.destroy();delete this._datgui;return}if(!g){return}var l=this;this._datgui=new dat.GUI({width:Math.min(650,l._renderer.domElement.width/2)});var c=new THREE.Box3().setFromObject(this._toplevel);c.expandByVector(c.size().multiplyScalar(0.01));var e=this._datgui.addFolder("Clipping");var j=e.add(this,"enableX").name("Enable X").listen();j.onChange(function(o){l.enableX=o;l._enableSSAO=o?false:l._enableSSAO;l.updateClipping()});if(this.clipX===0){this.clipX=(c.min.x+c.max.x)/2}var m=e.add(this,"clipX",c.min.x,c.max.x).name("X Position");m.onChange(function(o){l.clipX=o;if(l.enableX){l.updateClipping()}});var i=e.add(this,"enableY").name("Enable Y").listen();i.onChange(function(o){l.enableY=o;l._enableSSAO=o?false:l._enableSSAO;l.updateClipping()});if(this.clipY===0){this.clipY=(c.min.y+c.max.y)/2}var k=e.add(this,"clipY",c.min.y,c.max.y).name("Y Position");k.onChange(function(o){l.clipY=o;if(l.enableY){l.updateClipping()}});var f=e.add(this,"enableZ").name("Enable Z").listen();f.onChange(function(o){l.enableZ=o;l._enableSSAO=o?false:l._enableSSAO;l.updateClipping()});if(this.clipZ===0){this.clipZ=(c.min.z+c.max.z)/2}var h=e.add(this,"clipZ",c.min.z,c.max.z).name("Z Position");h.onChange(function(o){l.clipZ=o;if(l.enableZ){l.updateClipping()}});var d=this._datgui.addFolder("Appearance");if(this._webgl){d.add(this,"_enableSSAO").name("Smooth Lighting (SSAO)").onChange(function(o){l._renderer.antialias=!l._renderer.antialias;l.enableX=o?false:l.enableX;l.enableY=o?false:l.enableY;l.enableZ=o?false:l.enableZ;l.updateClipping()}).listen()}d.add(this.options,"highlight").name("Highlight Selection").onChange(function(o){if(o===false){if(l._selected.mesh!==null){l._selected.mesh.material.color=l._selected.originalColor;l.Render3D(0);l._selected.mesh=null}}});d.add(this,"globalTransparency",0,1).listen().onChange(function(o){l._toplevel.traverse(function(p){if(p instanceof THREE.Mesh){if(p.material.alwaysTransparent!==undefined){if(!p.material.alwaysTransparent){p.material.transparent=o!==1}p.material.opacity=Math.min(o*o,p.material.inherentOpacity)}}});l.Render3D(0)});d.add(this.options,"wireframe").name("Wireframe").onChange(function(o){l.changeWireFrame(l._scene,l.options.wireframe)});d.add(this,"focusCamera").name("Reset camera position");if(this._webgl){var n=this._datgui.addFolder("Advanced");n.add(this._advceOptions,"aoClamp",0,1).listen().onChange(function(o){l._ssaoPass.uniforms.aoClamp.value=o;l._enableSSAO=true;l.Render3D(0)});n.add(this._advceOptions,"lumInfluence",0,1).listen().onChange(function(o){l._ssaoPass.uniforms.lumInfluence.value=o;l._enableSSAO=true;l.Render3D(0)});n.add(this._advceOptions,"clipIntersection").listen().onChange(function(o){l._renderer.clipIntersection=o;l.Render3D(0)});n.add(this._advceOptions,"depthTest").onChange(function(o){l._toplevel.traverse(function(p){if(p instanceof THREE.Mesh){p.material.depthTest=o}});l.Render3D(0)}).listen();n.add(this,"resetAdvanced").name("Reset")}};a.TGeoPainter.prototype.OrbitContext=function(e,d){var c=this;a.Painter.createMenu(function(i){i.painter=c;if(!d||(d.length==0)){c.FillContextMenu(i)}else{var l=(d.length>1);if(l){i.add("header: Nodes")}for(var k=0;k<d.length;++k){var h=d[k].object;var g=c._clones.ResolveStack(h.stack).name;var j="header";if(g.indexOf("Nodes/")===0){j=g.substr(6)}else{if(g.length>0){j=g}else{if(c.GetItemName()){j=c.GetItemName()}}}i.add((l?"sub:":"header:")+j,g,function(m){this.ActiavteInBrowser([m],true)});i.add("Browse",g,function(m){this.ActiavteInBrowser([m],true)});var f=c.accessObjectWireFrame(h);if(f!==undefined){i.addchk(f,"Wireframe",k,function(o){var n=d[o].object.material;n.wireframe=!n.wireframe;this.Render3D()})}if(k>0){i.add("Manifest",k,function(n){if(this._last_manifest){this._last_manifest.wireframe=!this._last_manifest.wireframe}if(this._last_hidden){this._last_hidden.forEach(function(o){o.visible=true})}this._last_hidden=[];for(var m=0;m<n;++m){this._last_hidden.push(d[m].object)}this._last_hidden.forEach(function(o){o.visible=false});this._last_manifest=d[n].object.material;this._last_manifest.wireframe=!this._last_manifest.wireframe;this.Render3D()})}i.add("Focus",k,function(m){this.focusCamera(d[m].object)});i.add("Hide",k,function(m){var n=c._clones.ResolveStack(d[m].object.stack);if(n.obj&&n.obj.fVolume){a.GEO.SetBit(n.obj.fVolume,a.GEO.BITS.kVisThis,false);a.GEO.updateBrowserIcons(n.obj.fVolume,a.hpainter)}this.testGeomChanges()});if(l){i.add("endsub:")}}}i.show(e)})};a.TGeoPainter.prototype.FilterIntersects=function(h){for(var l=h.length-1;l>=0;--l){var j=h[l].object.stack!==undefined;for(var e=0;(e<l)&&j;++e){if(h[e].object===h[l].object){j=false}}if(!j){h.splice(l,1)}}if(this.enableX||this.enableY||this.enableZ){var g=[];for(var f=0;f<h.length;++f){var d=false;var c=h[f].point;if(this.enableX&&this._clipPlanes[0].normal.dot(c)>this._clipPlanes[0].constant){d=true}if(this.enableY&&this._clipPlanes[1].normal.dot(c)>this._clipPlanes[1].constant){d=true}if(this.enableZ&&this._clipPlanes[2].normal.dot(c)>this._clipPlanes[2].constant){d=true}if(d){g.push(h[f])}}h=g}return h};a.TGeoPainter.prototype.testCameraPositionChange=function(){if(!this.options.select_in_view||this._draw_all_nodes){return}var c=a.GEO.CreateProjectionMatrix(this._camera);var d=a.GEO.CreateFrustum(c);if(!d.CheckBox(new THREE.Box3().setFromObject(this._toplevel))){this.startDrawGeometry()}};a.TGeoPainter.prototype.addOrbitControls=function(){if(this._controls){return}this.select_main().property("flex_block_drag",true);var c=this;this._controls=a.Painter.CreateOrbitControl(this,this._camera,this._scene,this._renderer,this._lookat);this._controls.ContextMenu=this.OrbitContext.bind(this);this._controls.ProcessMouseMove=function(d){var e=null;if(c.options.highlight){if(c._selected.mesh!==null){c._selected.mesh.material.color=c._selected.originalColor}if(d.length>0){c._selected.mesh=d[0].object;c._selected.originalColor=c._selected.mesh.material.color;c._selected.mesh.material.color=new THREE.Color(16755251);c.Render3D(0);if(d[0].object.stack){e=c._clones.ResolveStack(d[0].object.stack).name}}}if(d.length===0&&c._selected.mesh!==null){c._selected.mesh.material.color=c._selected.originalColor;c.Render3D(0);c._selected.mesh=null}var g=[];if(c.options.update_browser){if(c.options.highlight){if(e!==null){g.push(e)}}else{for(var h=0;h<d.length;++h){var f=d[h].object;if(f.stack){g.push(c._clones.ResolveStack(f.stack).name)}}}c.ActiavteInBrowser(g)}return e};this._controls.ProcessMouseLeave=function(){if(c.options.update_browser){c.ActiavteInBrowser([])}};this._controls.ProcessMouseDblclick=function(){if(c._last_manifest){c._last_manifest.wireframe=!c._last_manifest.wireframe;if(c._last_hidden){c._last_hidden.forEach(function(d){d.visible=true})}delete c._last_hidden;delete c._last_manifest;c.Render3D()}else{c.adjustCameraPosition()}}};a.TGeoPainter.prototype.addTransformControl=function(){if(this._tcontrols){return}if(!this.options._debug&&!this.options._grid){return}return;this._tcontrols=new THREE.TransformControls(this._camera,this._renderer.domElement);this._scene.add(this._tcontrols);this._tcontrols.attach(this._toplevel);window.addEventListener("keydown",function(c){switch(c.keyCode){case 81:painter._tcontrols.setSpace(painter._tcontrols.space==="local"?"world":"local");break;case 17:painter._tcontrols.setTranslationSnap(Math.ceil(painter._overall_size)/50);painter._tcontrols.setRotationSnap(THREE.Math.degToRad(15));break;case 84:painter._tcontrols.setMode("translate");break;case 82:painter._tcontrols.setMode("rotate");break;case 83:painter._tcontrols.setMode("scale");break;case 187:case 107:painter._tcontrols.setSize(painter._tcontrols.size+0.1);break;case 189:case 109:painter._tcontrols.setSize(Math.max(painter._tcontrols.size-0.1,0.1));break}});window.addEventListener("keyup",function(c){switch(c.keyCode){case 17:painter._tcontrols.setTranslationSnap(null);painter._tcontrols.setRotationSnap(null);break}});this._tcontrols.addEventListener("change",function(){painter.Render3D(0)})};a.TGeoPainter.prototype.createFlippedMesh=function(q,k,j){var h=new THREE.Vector3(1,1,-1);if(k.geomZ===undefined){if(k.geom.type=="BufferGeometry"){var p=k.geom.getAttribute("position").array,c=k.geom.getAttribute("normal").array,i=p.length,f,e=0,o=new Float32Array(i),g=new Float32Array(i);for(f=0;f<i;f+=3){o[f]=p[f+e];o[f+1]=p[f+1+e];o[f+2]=-p[f+2+e];g[f]=c[f+e];g[f+1]=c[f+1+e];g[f+2]=-c[f+2+e];e+=3;if(e===6){e=-3}}k.geomZ=new THREE.BufferGeometry();k.geomZ.addAttribute("position",new THREE.BufferAttribute(o,3));k.geomZ.addAttribute("normal",new THREE.BufferAttribute(g,3))}else{k.geomZ=k.geom.clone();k.geomZ.scale(h.x,h.y,h.z);var m,l;for(var f=0;f<k.geomZ.faces.length;++f){m=geom.faces[f];l=m.b;m.b=m.c;m.c=l}}}var r=new THREE.Mesh(k.geomZ,j);r.scale.copy(h);r.updateMatrix();return r};a.TGeoPainter.prototype.nextDrawAction=function(){if(!this._clones||(this.drawing_stage==0)){return false}if(this.drawing_stage==1){if(this.options.use_worker>0){if(!this._worker){this.startWorker();return 1}if(!this._worker_ready){return 1}}var o=this._clones.MarkVisisble(),t=null,m=null;if(this.options.select_in_view&&!this._first_drawing){t=a.GEO.CreateProjectionMatrix(this._camera);m=a.GEO.CreateFrustum(t);if(m.CheckBox(new THREE.Box3().setFromObject(this._toplevel))){t=null;m=null}}this._current_face_limit=this.options.maxlimit;if(t){this._current_face_limit*=1.25}var q=(o>10000)||(t&&(this._clones.ScanVisible()>100000));if(q&&!this._worker&&(this.options.use_worker>=0)){this.startWorker()}if(!q||!this._worker_ready){var z=this._clones.CollectVisibles(this._current_face_limit,m);this._new_draw_nodes=z.lst;this._draw_all_nodes=z.complete;this.drawing_stage=3;return true}var k={collect:this._current_face_limit,visible:this._clones.GetVisibleFlags(),matrix:t?t.elements:null};this.submitToWorker(k);this.drawing_stage=2;this.drawing_log="Worker select visibles";return 2}if(this.drawing_stage==2){this.drawing_log="Worker select visibles";return 2}if(this.drawing_stage==3){this.drawing_log="Analyse visibles";if(this._draw_nodes){var l=this._clones.MergeVisibles(this._new_draw_nodes,this._draw_nodes);for(var s=0;s<l.length;++s){this._clones.CreateObject3D(l[s].stack,this._toplevel,"delete_mesh")}if(l.length>0){this.drawing_log="Delete "+l.length+" nodes"}}this._draw_nodes=this._new_draw_nodes;delete this._new_draw_nodes;this.drawing_stage=4;return true}if(this.drawing_stage===4){this.drawing_log="Collect shapes";var r=this._clones.CollectShapes(this._draw_nodes);this._build_shapes=this._clones.MergeShapesLists(this._build_shapes,r);this.drawing_stage=5;return true}if(this.drawing_stage===5){if(this.canSubmitToWorker()){var k={limit:this._current_face_limit,shapes:[]},u=0;for(var s=0;s<this._build_shapes.length;++s){var x=null,w=this._build_shapes[s];if(w.ready||w.geom){x={id:w.id,ready:true,nfaces:a.GEO.numGeometryFaces(w.geom),refcnt:w.refcnt}}else{x=a.clone(w,null,true);u++}k.shapes.push(x)}if(u>0){this.submitToWorker(k);this.drawing_log="Worker build shapes";this.drawing_stage=6;return 2}}this.drawing_stage=7}if(this.drawing_stage===6){return 2}if((this.drawing_stage===7)||(this.drawing_stage===8)){if(this.drawing_stage===7){var z=this._clones.BuildShapes(this._build_shapes,this._current_face_limit,500);if(z.done){this.drawing_stage=8}else{this.drawing_log="Creating: "+z.shapes+" / "+this._build_shapes.length+" shapes,  "+z.faces+" faces";if(z.notusedshapes<30){return true}}}var i=new Date().getTime(),p=true;for(var s=0;s<this._draw_nodes.length;++s){var f=this._draw_nodes[s];if(f.done){continue}var e=this._build_shapes[f.shapeid];if(!e.ready){if(this.drawing_stage===8){console.warn("shape marked as not ready when should")}p=false;continue}f.done=true;e.used=true;if(!e.geom||(e.nfaces===0)){this._clones.CreateObject3D(f.stack,this._toplevel,"delete_mesh");continue}var y=this._clones.CreateObject3D(f.stack,this._toplevel,this.options);var j=this._clones.origin[f.nodeid];var x=this._clones.nodes[f.nodeid];var g=a.GEO.getNodeProperties(x.kind,j,true);this._num_meshes++;this._num_faces+=e.nfaces;g.material.wireframe=this.options.wireframe;g.material.side=this.bothSides?THREE.DoubleSide:THREE.FrontSide;var d;if(y.matrixWorld.determinant()>-0.9){d=new THREE.Mesh(e.geom,g.material)}else{d=this.createFlippedMesh(y,e,g.material)}d.stack=f.stack;y.add(d);if(this.options._debug||this.options._full){var c=new THREE.WireframeHelper(d);c.material.color.set(g.fillcolor);c.material.linewidth=("fVolume" in j)?j.fVolume.fLineWidth:1;y.add(c)}if(this.options._bound||this.options._full){var v=new THREE.BoxHelper(d);y.add(v)}var h=new Date().getTime();if(h-i>500){p=false;break}}if(p){this.drawing_log="Building done";this.drawing_stage=0;return false}if(this.drawing_stage>7){this.drawing_log="Building meshes "+this._num_meshes+" / "+this._num_faces}return true}console.log("never come here");return false};a.TGeoPainter.prototype.SameMaterial=function(e,c){if((e===null)||(c===null)){return e===c}if(e.fVolume.fLineColor>=0){return(e.fVolume.fLineColor===c.fVolume.fLineColor)}var f=(e.fVolume.fMedium!==null)?e.fVolume.fMedium.fMaterial:null;var d=(c.fVolume.fMedium!==null)?c.fVolume.fMedium.fMaterial:null;if(f===d){return true}if((f===null)||(d===null)){return false}return(f.fFillStyle===d.fFillStyle)&&(f.fFillColor===d.fFillColor)};a.TGeoPainter.prototype.createScene=function(i,c,f,e){this._scene=new THREE.Scene();this._scene.fog=new THREE.Fog(16777215,1,10000);this._scene.overrideMaterial=new THREE.MeshLambertMaterial({color:7340287,transparent:true,opacity:0.2,depthTest:false});this._scene_width=c;this._scene_height=f;this._camera=new THREE.PerspectiveCamera(25,c/f,1,10000);this._camera.up=this.options._yup?new THREE.Vector3(0,1,0):new THREE.Vector3(0,0,1);this._scene.add(this._camera);this._selected={mesh:null,originalColor:null};this._overall_size=10;this._toplevel=new THREE.Object3D();this._scene.add(this._toplevel);this._renderer=i?new THREE.WebGLRenderer({antialias:true,logarithmicDepthBuffer:false,preserveDrawingBuffer:true}):new THREE.CanvasRenderer({antialias:true});this._renderer.setPixelRatio(e);this._renderer.setClearColor(16777215,1);this._renderer.setSize(c,f);this._renderer.clipIntersection=true;this._animating=false;this.bothSides=false;this.enableX=this.enableY=this.enableZ=false;this.clipX=this.clipY=this.clipZ=0;this._clipPlanes=[new THREE.Plane(new THREE.Vector3(1,0,0),this.clipX),new THREE.Plane(new THREE.Vector3(0,this.options._yup?-1:1,0),this.clipY),new THREE.Plane(new THREE.Vector3(0,0,this.options._yup?1:-1),this.clipZ)];this._pointLight=new THREE.PointLight(15724527,1);this._camera.add(this._pointLight);this._pointLight.position.set(10,10,10);this.globalTransparency=1;this._defaultAdvanced={aoClamp:0.7,lumInfluence:0.4,clipIntersection:true,depthTest:true};this._enableSSAO=false;if(i){var g=new THREE.RenderPass(this._scene,this._camera);this._depthMaterial=new THREE.MeshDepthMaterial({side:THREE.DoubleSide});this._depthMaterial.depthPacking=THREE.RGBADepthPacking;this._depthMaterial.blending=THREE.NoBlending;var d={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter};this._depthRenderTarget=new THREE.WebGLRenderTarget(c,f,d);this._ssaoPass=new THREE.ShaderPass(THREE.SSAOShader);this._ssaoPass.renderToScreen=true;this._ssaoPass.uniforms.tDepth.value=this._depthRenderTarget.texture;this._ssaoPass.uniforms.size.value.set(c,f);this._ssaoPass.uniforms.cameraNear.value=this._camera.near;this._ssaoPass.uniforms.cameraFar.value=this._camera.far;this._ssaoPass.uniforms.onlyAO.value=false;this._ssaoPass.uniforms.aoClamp.value=this._defaultAdvanced.aoClamp;this._ssaoPass.uniforms.lumInfluence.value=this._defaultAdvanced.lumInfluence;this._effectComposer=new THREE.EffectComposer(this._renderer);this._effectComposer.addPass(g);this._effectComposer.addPass(this._ssaoPass)}this._advceOptions={};this.resetAdvanced()};a.TGeoPainter.prototype.startDrawGeometry=function(c){if(!c&&(this.drawing_stage!==0)){this._draw_nodes_again=true;return}this._startm=new Date().getTime();this._last_render_tm=this._startm;this._last_render_meshes=0;this.drawing_stage=1;this.drawing_log="collect visible";this._num_meshes=0;this._num_faces=0;delete this._last_manifest;delete this._last_hidden;delete this._draw_nodes_again;this.continueDraw()};a.TGeoPainter.prototype.resetAdvanced=function(){if(this._webgl){this._advceOptions.aoClamp=this._defaultAdvanced.aoClamp;this._advceOptions.lumInfluence=this._defaultAdvanced.lumInfluence;this._ssaoPass.uniforms.aoClamp.value=this._defaultAdvanced.aoClamp;this._ssaoPass.uniforms.lumInfluence.value=this._defaultAdvanced.lumInfluence}this._advceOptions.depthTest=this._defaultAdvanced.depthTest;this._advceOptions.clipIntersection=this._defaultAdvanced.clipIntersection;this._renderer.clipIntersection=this._defaultAdvanced.clipIntersection;var c=this;this._toplevel.traverse(function(d){if(d instanceof THREE.Mesh){d.material.depthTest=c._defaultAdvanced.depthTest}});this.Render3D(0)};a.TGeoPainter.prototype.updateMaterialSide=function(c,d){if((this.bothSides===c)&&!d){return}this._scene.traverse(function(e){if(e.hasOwnProperty("material")&&("emissive" in e.material)){e.material.side=c?THREE.DoubleSide:THREE.FrontSide;e.material.needsUpdate=true}});this.bothSides=c};a.TGeoPainter.prototype.updateClipping=function(c){this._clipPlanes[0].constant=this.clipX;this._clipPlanes[1].constant=-this.clipY;this._clipPlanes[2].constant=this.options._yup?-this.clipZ:this.clipZ;this._renderer.clippingPlanes=[];if(this.enableX){this._renderer.clippingPlanes.push(this._clipPlanes[0])}if(this.enableY){this._renderer.clippingPlanes.push(this._clipPlanes[1])}if(this.enableZ){this._renderer.clippingPlanes.push(this._clipPlanes[2])}this.updateMaterialSide(this.enableX||this.enableY||this.enableZ);if(!c){this.Render3D(0)}};a.TGeoPainter.prototype.adjustCameraPosition=function(i){var h=new THREE.Box3().setFromObject(this._toplevel);var e=h.max.x-h.min.x,c=h.max.y-h.min.y,j=h.max.z-h.min.z,g=(h.max.x+h.min.x)/2,f=(h.max.y+h.min.y)/2,d=(h.max.z+h.min.z)/2;this._overall_size=2*Math.max(e,c,j);this._scene.fog.near=this._overall_size*2;this._camera.near=this._overall_size/350;this._scene.fog.far=this._overall_size*12;this._camera.far=this._overall_size*12;if(this._webgl){this._ssaoPass.uniforms.cameraNear.value=this._camera.near;this._ssaoPass.uniforms.cameraFar.value=this._camera.far}if(i){this.clipX=g;this.clipY=f;this.clipZ=d}this._camera.updateProjectionMatrix();if(this.options._yup){this._camera.position.set(g-2*Math.max(e,j),f+2*c,d-2*Math.max(e,j))}else{this._camera.position.set(g-2*Math.max(e,c),f-2*Math.max(e,c),d+2*j)}this._lookat=new THREE.Vector3(g,f,d);this._camera.lookAt(this._lookat);this._pointLight.position.set(e/5,c/5,j/5);if(this._controls){this._controls.target.copy(this._lookat);this._controls.update()}if(this.options.select_in_view){this.startDrawGeometry()}};a.TGeoPainter.prototype.focusOnItem=function(e){if(!e||(e.indexOf("Nodes/")!==0)||!this._clones){return}var c=this._clones.FindStackByName(e.substr(6));if(!c){return}var d=this._clones.ResolveStack(c,true);this.focusCamera(d,false)};a.TGeoPainter.prototype.focusCamera=function(m,v){var q=v===undefined?false:v;var k=new THREE.Box3();if(m===undefined){k.setFromObject(this._toplevel)}else{if(m instanceof THREE.Mesh){k.setFromObject(m)}else{var A=new THREE.Vector3().setFromMatrixPosition(m.matrix);var p=m.node;var n=new THREE.Vector3(p.fDX,p.fDY,p.fDZ).multiplyScalar(0.5);k.min=A.clone().sub(n);k.max=A.clone().add(n)}}var z=k.max.x-k.min.x,x=k.max.y-k.min.y,w=k.max.z-k.min.z,u=(k.max.x+k.min.x)/2,t=(k.max.y+k.min.y)/2,r=(k.max.z+k.min.z)/2;var C;if(this.options._yup){C=new THREE.Vector3(u-2*Math.max(z,w),t+2*x,r-2*Math.max(z,w))}else{C=new THREE.Vector3(u-2*Math.max(z,x),t-2*Math.max(z,x),r+2*w)}var B=new THREE.Vector3(u,t,r);var o=this._camera.position.distanceTo(B);var s=this._controls.target;var l=200;var i=0;var f=C.sub(this._camera.position).divideScalar(l);var j=B.sub(s).divideScalar(l);console.log(j);if(q){var g=new THREE.Box3().setFromObject(this._toplevel);this.clipX=this.enableX?this.clipX:g.min.x;this.clipY=this.enableY?this.clipY:g.min.y;this.clipZ=this.enableZ?this.clipZ:g.min.z;this.enableX=this.enableY=this.enableZ=true;var e=((k.max.x+k.min.x)/2-this.clipX)/l,d=((k.max.y+k.min.y)/2-this.clipY)/l,c=((k.max.z+k.min.z)/2-this.clipZ)/l;this.updateClipping()}var y=this;this._animating=true;this._controls.autoRotate=false;function h(){if(y._animating){requestAnimationFrame(h)}else{y.startDrawGeometry()}var D=-Math.cos((2*Math.PI*i)/l)+1;y._camera.position.add(f.clone().multiplyScalar(D));s.add(j.clone().multiplyScalar(D));y._lookat=s;y._camera.lookAt(y._lookat);y._camera.updateProjectionMatrix();if(q){y.clipX+=e*D;y.clipY+=d*D;y.clipZ+=c*D;y.updateClipping()}else{y.Render3D()}i++;y._animating=i<l}h()};a.TGeoPainter.prototype.autorotate=function(g){var e=g===undefined?2:g;var c=this;var f=new Date();function d(){var h=new Date();if(c._controls.autoRotate){requestAnimationFrame(d)}c._controls.autoRotateSpeed=e*(h.getTime()-f.getTime())/16.6666;c._controls.update();f=new Date();c.Render3D(0)}d()};a.TGeoPainter.prototype.completeScene=function(){if(this.options._debug||this.options._grid){if(this.options._full){var c=new THREE.BoxHelper(this._toplevel);this._scene.add(c)}this._scene.add(new THREE.AxisHelper(2*this._overall_size));this._scene.add(new THREE.GridHelper(Math.ceil(this._overall_size),Math.ceil(this._overall_size)/50));this.helpText("<font face='verdana' size='1' color='red'><center>Transform Controls<br>'T' translate | 'R' rotate | 'S' scale<br>'+' increase size | '-' decrease size<br>'W' toggle wireframe/solid display<br>keep 'Ctrl' down to snap to grid</center></font>")}};a.TGeoPainter.prototype.drawCount=function(k,g){var h="Unique nodes: "+this._clones.nodes.length+"<br/>Unique visible: "+k+"<br/>Time to clone: "+g+"ms <br/>";this._clones.ScanVisible();var l={cnt:[],func:function(m){if(this.cnt[this.last]===undefined){this.cnt[this.last]=1}else{this.cnt[this.last]++}return true}};var d=new Date().getTime();var f=this._clones.ScanVisible(l);var c=new Date().getTime();h+="Total visible nodes: "+f+"<br/>";for(var i=0;i<l.cnt.length;++i){if(l.cnt[i]!==undefined){h+=("  lvl"+i+": "+l.cnt[i]+"<br/>")}}h+="Time to scan: "+(c-d)+"ms <br/>";h+="<br/><br/>Check timing for matrix calculations ...<br/>";var e=this.select_main().style("overflow","auto").html(h);var j=this;setTimeout(function(){l.domatrix=true;d=new Date().getTime();f=j._clones.ScanVisible(l);c=new Date().getTime();e.append("p").text("Time to scan with matrix: "+(c-d)+"ms")},100);return this.DrawingReady()};a.TGeoPainter.prototype.DrawGeometry=function(f){if(typeof f!=="string"){f=""}var e=this.size_for_3d();this._webgl=a.Painter.TestWebGL();this.options=this.decodeOptions(f);if(!("_yup" in this.options)){this.options._yup=this.svg_canvas().empty()}var d=new Date().getTime();this._clones=new a.GEO.ClonedNodes(this.GetObject());var g=this._clones.MarkVisisble(true);if(g<=0){g=this._clones.MarkVisisble(false)}else{g=this._clones.MarkVisisble(true,true)}var c=new Date().getTime();console.log("Creating clones",this._clones.nodes.length,"takes",c-d,"uniquevis",g);if(this.options._count){return this.drawCount(g,c-d)}this.options.maxlimit=(this._webgl?200000:100000)*this.options.more;this._first_drawing=true;if(this.options.use_worker>0){this.startWorker()}this.createScene(this._webgl,e.width,e.height,window.devicePixelRatio);this.add_3d_canvas(e,this._renderer.domElement);this.CreateToolbar();this.startDrawGeometry(true);return this};a.TGeoPainter.prototype.continueDraw=function(){if(this.drawing_stage===0){return}var d=new Date().getTime(),c=this._first_drawing?1000:200,e=d;while(true){var f=this.nextDrawAction();if(!f){break}e=new Date().getTime();if(e-this._startm>100000){this.drawing_stage=0;break}if((f===true)&&(e-d<c)){continue}if((e-d>c)||(f===1)||(f===2)){a.progress(this.drawing_log);if(this._first_drawing&&this._webgl&&(this._num_meshes-this._last_render_meshes>100)&&(e-this._last_render_tm>2.5*c)){this.adjustCameraPosition();this.Render3D(-1);this._last_render_tm=new Date().getTime();this._last_render_meshes=this._num_meshes}if(f!==2){setTimeout(this.continueDraw.bind(this),(f===1)?100:1)}return}}var g=e-this._startm;if(this._first_drawing){a.console("Create tm = "+g+" meshes "+this._num_meshes+" faces "+this._num_faces)}if(g>300){a.progress("Rendering geometry");return setTimeout(this.completeDraw.bind(this,true),10)}this.completeDraw(true)};a.TGeoPainter.prototype.Render3D=function(f,e){if(f===undefined){f=5}if(f<=0){if("render_tmout" in this){clearTimeout(this.render_tmout)}var d=new Date();if(typeof this.TestAxisVisibility==="function"){this.TestAxisVisibility(this._camera,this._toplevel)}if(this._webgl&&this._enableSSAO){this._scene.overrideMaterial=this._depthMaterial;this._renderer.render(this._scene,this._camera,this._depthRenderTarget,true);this._scene.overrideMaterial=null;this._effectComposer.render()}else{this._renderer.render(this._scene,this._camera)}var c=new Date();this.last_render_tm=c.getTime()-d.getTime();delete this.render_tmout;if((this.first_render_tm===0)&&e){this.first_render_tm=this.last_render_tm;a.console("First render tm = "+this.first_render_tm)}return}if(!this.render_tmout){this.render_tmout=setTimeout(this.Render3D.bind(this,0,e),f)}};a.TGeoPainter.prototype.startWorker=function(){if(this._worker){return}this._worker_ready=false;this._worker_jobs=0;var c=this;this._worker=new Worker(a.source_dir+"scripts/JSRootGeoWorker.js");this._worker.onmessage=function(d){if(typeof d.data!=="object"){return}if("log" in d.data){return a.console("geo: "+d.data.log)}if("progress" in d.data){return a.progress(d.data.progress)}d.data.tm3=new Date().getTime();if("init" in d.data){c._worker_ready=true;return a.console("Worker ready: "+(d.data.tm3-d.data.tm0))}c.processWorkerReply(d.data)};this._worker.postMessage({init:true,tm0:new Date().getTime(),clones:this._clones.nodes,sortmap:this._clones.sortmap})};a.TGeoPainter.prototype.canSubmitToWorker=function(c){if(!this._worker){return false}return this._worker_ready&&((this._worker_jobs==0)||c)};a.TGeoPainter.prototype.submitToWorker=function(c){if(!this._worker){return false}this._worker_jobs++;c.tm0=new Date().getTime();this._worker.postMessage(c)};a.TGeoPainter.prototype.processWorkerReply=function(e){this._worker_jobs--;if("collect" in e){this._new_draw_nodes=e.new_nodes;this._draw_all_nodes=e.complete;this.drawing_stage=3;return this.continueDraw()}if("shapes" in e){for(var f=0;f<e.shapes.length;++f){var d=e.shapes[f],c=this._build_shapes[f];if(d.buf_pos&&d.buf_norm){if(d.buf_pos.length===0){c.geom=null}else{if(d.buf_pos.length!==d.buf_norm.length){console.error("item.buf_pos",d.buf_pos.length,"item.buf_norm",d.buf_norm.length);c.geom=null}else{c.geom=new THREE.BufferGeometry();c.geom.addAttribute("position",new THREE.BufferAttribute(d.buf_pos,3));c.geom.addAttribute("normal",new THREE.BufferAttribute(d.buf_norm,3))}}c.ready=true;c.nfaces=d.nfaces}}e.tm4=new Date().getTime();this.drawing_stage=7;return this.continueDraw()}};a.TGeoPainter.prototype.testGeomChanges=function(){this.startDrawGeometry()};a.TGeoPainter.prototype.toggleAxisDraw=function(d){if(this.TestAxisVisibility!==undefined){if(d){return}this.TestAxisVisibility(null,this._toplevel)}else{var c=a.Create("TNamed");c._typename="TAxis3D";c._main=this;a.draw(this.divid,c)}};a.TGeoPainter.prototype.completeDraw=function(c){var d=false;if(this._first_drawing){this.adjustCameraPosition(true);this._first_drawing=false;d=true;if(this._webgl){this.enableX=this.options.clipx;this.enableY=this.options.clipy;this.enableZ=this.options.clipz;this.updateClipping(true)}}this.completeScene();if(this.options._axis){this.options._axis=false;this.toggleAxisDraw()}this._scene.overrideMaterial=null;this.Render3D(0,true);if(c){a.progress()}this.addOrbitControls();this.addTransformControl();this.showControlOptions(this.options.show_controls);if(d){this.DrawingReady()}if(this._draw_nodes_again){this.startDrawGeometry()}};a.TGeoPainter.prototype.Cleanup=function(d){if(!d){this.helpText();a.Painter.DisposeThreejsObject(this._scene);if(this._tcontrols){this._tcontrols.dispose()}if(this._controls){this._controls.dispose()}if(this._context_menu){this._renderer.domElement.removeEventListener("contextmenu",this._context_menu,false)}if(this._datgui){this._datgui.destroy()}var c=this.GetObject();if(c){delete c._painter}if(this._worker){this._worker.terminate()}}delete this._scene;this._scene_width=0;this._scene_height=0;this._renderer=null;this._toplevel=null;delete this._clone;this._camera=null;this.first_render_tm=0;this.last_render_tm=2000;this.drawing_stage=0;delete this._datgui;delete this._controls;delete this._context_menu;delete this._tcontrols;delete this._toolbar;delete this._worker};a.TGeoPainter.prototype.helpText=function(c){a.progress(c)};a.TGeoPainter.prototype.CheckResize=function(d){var e=this.pad_painter();if(e){if(!e.CheckCanvasResize(d)){return false}}var c=this.size_for_3d();if((this._scene_width===c.width)&&(this._scene_height===c.height)){return false}if((c.width<10)||(c.height<10)){return}this._scene_width=c.width;this._scene_height=c.height;this._camera.aspect=this._scene_width/this._scene_height;this._camera.updateProjectionMatrix();this._renderer.setSize(this._scene_width,this._scene_height);this.Render3D();return true};a.TGeoPainter.prototype.ownedByTransformControls=function(d){var c=d.parent;while(c&&!(c instanceof THREE.TransformControls)){c=c.parent}return(c&&(c instanceof THREE.TransformControls))};a.TGeoPainter.prototype.accessObjectWireFrame=function(d,c){if(!d.hasOwnProperty("material")||(d instanceof THREE.GridHelper)){return}if(this.ownedByTransformControls(d)){return}if((c!==undefined)&&d.stack){d.material.wireframe=c}return d.material.wireframe};a.TGeoPainter.prototype.changeWireFrame=function(e,d){var c=this;e.traverse(function(f){c.accessObjectWireFrame(f,d)});this.Render3D()};a.Painter.drawGeoObject=function(f,e,d){if(e===null){return null}a.GEO.GradPerSegm=a.gStyle.GeoGradPerSegm;a.GEO.CompressComp=a.gStyle.GeoCompressComp;var c=null;if(("fShapeBits" in e)&&("fShapeId" in e)){c=e;e=null}else{if((e._typename==="TGeoVolumeAssembly")||(e._typename==="TGeoVolume")){c=e.fShape}else{if(e._typename==="TEveGeoShapeExtract"){c=e.fShape}else{if(e._typename==="TGeoManager"){e=e.fMasterVolume;c=e.fShape}else{if("fVolume" in e){if(e.fVolume){c=e.fVolume.fShape}}else{e=null}}}}}if(d&&d.indexOf("comp")==0&&c&&(c._typename=="TGeoCompositeShape")&&c.fNode){d=d.substr(4);e=a.GEO.buildCompositeVolume(c)}if(!e&&c){e=a.extend(a.Create("TEveGeoShapeExtract"),{fTrans:null,fShape:c,fRGBA:[0,1,0,1],fElements:null,fRnrSelf:true})}if(e){a.extend(this,new a.TGeoPainter(e));this.SetDivId(f,5);return this.DrawGeometry(d)}return this.DrawingReady()};a.Painter.drawGeometry=a.Painter.drawGeoObject;a.Painter.drawAxis3D=function(f,e,d){var c=new a.TObjectPainter(e);if(!("_main" in e)){c.SetDivId(f)}c.Draw3DAxis=function(){var g=this.main_painter();if((g===null)&&("_main" in this.GetObject())){g=this.GetObject()._main}if((g===null)||(g._toplevel===undefined)){return console.warn("no geo object found for 3D axis drawing")}var h=new THREE.Box3().setFromObject(g._toplevel);this.xmin=h.min.x;this.xmax=h.max.x;this.ymin=h.min.y;this.ymax=h.max.y;this.zmin=h.min.z;this.zmax=h.max.z;this.size3d=0;this.DrawXYZ=a.Painter.HPainter_DrawXYZ;this.DrawXYZ(g._toplevel);g.adjustCameraPosition();g.TestAxisVisibility=a.Painter.HPainter_TestAxisVisibility;g.Render3D()};c.Draw3DAxis();return c.DrawingReady()};a.GEO.buildCompositeVolume=function(e,g){var f=a.Create("TGeoVolume");if(g&&(e._typename!=="TGeoCompositeShape")){f.fName=g;a.GEO.SetBit(f,a.GEO.BITS.kVisThis,true);f.fLineColor=(g=="Left"?2:3);f.fShape=e;return f}a.GEO.SetBit(f,a.GEO.BITS.kVisDaughters,true);f._geoh=true;f.fName="";var d=a.Create("TGeoNodeMatrix");d.fName="Left";d.fMatrix=e.fNode.fLeftMat;d.fVolume=a.GEO.buildCompositeVolume(e.fNode.fLeft,"Left");var c=a.Create("TGeoNodeMatrix");c.fName="Right";c.fMatrix=e.fNode.fRightMat;c.fVolume=a.GEO.buildCompositeVolume(e.fNode.fRight,"Right");f.fNodes=a.Create("TList");f.fNodes.Add(d);f.fNodes.Add(c);return f};a.GEO.provideVisStyle=function(c){var e=!a.GEO.TestBit(c,a.GEO.BITS.kVisNone)&&a.GEO.TestBit(c,a.GEO.BITS.kVisThis);var d=a.GEO.TestBit(c,a.GEO.BITS.kVisDaughters)||a.GEO.TestBit(c,a.GEO.BITS.kVisOneLevel);if(d&&(!c.fNodes||(c.fNodes.arr.length===0))){d=false}if(e&&d){return" geovis_all"}if(e){return" geovis_this"}if(d){return" geovis_daughters"}return""};a.GEO.getBrowserItem=function(c,e,d){if(c._geoobj){c._geoobj._geoh=true}a.CallBack(d,c,c._geoobj)};a.GEO.createItem=function(g,i,d){var e={_kind:"ROOT."+i._typename,_name:d?d:i.fName,_title:i.fTitle,_parent:g,_geoobj:i,_get:a.GEO.getBrowserItem};var f,c,h;if(i._typename=="TGeoMaterial"){e._icon="img_geomaterial"}else{if(i._typename=="TGeoMedium"){e._icon="img_geomedium"}else{if(i._typename=="TGeoMixture"){e._icon="img_geomixture"}else{if((i._typename.indexOf("TGeoNode")===0)&&i.fVolume){e._title="node:"+i._typename;if(i.fTitle.length>0){e._title+=" "+i.fTitle}f=i.fVolume}else{if(i._typename.indexOf("TGeoVolume")===0){f=i}else{if(i._typename=="TEveGeoShapeExtract"){c=i.fShape;h=i.fElements?i.fElements.arr:null}else{if((i.fShapeBits!==undefined)&&(i.fShapeId!==undefined)){c=i}}}}}}}if(f){c=f.fShape;h=f.fNodes?f.fNodes.arr:null}if(f||c||h){if(f){e._volume=f}if(h){e._more=true;e._expand=a.GEO.expandObject}else{if(c&&(c._typename==="TGeoCompositeShape")&&c.fNode){e._more=true;e._shape=c;e._expand=function(j,k){a.GEO.createItem(j,j._shape.fNode.fLeft,"Left");a.GEO.createItem(j,j._shape.fNode.fRight,"Right");return true}}}if(!e._title&&(i._typename!="TGeoVolume")){e._title=i._typename}if(c){if(e._title==""){e._title=c._typename}e._icon=a.GEO.getShapeIcon(c)}else{e._icon=e._more?"img_geocombi":"img_geobbox"}if(f){e._icon+=a.GEO.provideVisStyle(f)}e._menu=a.GEO.provideMenu;e._icon_click=a.GEO.browserIconClick}if(!g._childs){g._childs=[]}g._childs.push(e);return e};a.GEO.createList=function(e,c,d,g){if((c==null)||!("arr" in c)||(c.arr.length==0)){return}var f={_name:d,_kind:"Folder",_title:g,_more:true,_geoobj:c,_parent:e};f._get=function(h,j,i){if("_geoobj" in h){return a.CallBack(i,h,h._geoobj)}a.CallBack(i,h,null)};f._expand=function(i,h){if("fVolume" in h){h=h.fVolume.fNodes}if(!("arr" in h)){return false}i._childs=[];for(var j in h.arr){a.GEO.createItem(i,h.arr[j])}return true};if(!e._childs){e._childs=[]}e._childs.push(f)};a.GEO.provideMenu=function(g,d,e){if(!d._volume||!d._geoobj){return false}g.add("separator");var c=d._volume;function f(h){a.GEO.ToggleBit(c,h);var i=d._icon.split(" ")[0]+a.GEO.provideVisStyle(c);e.ForEach(function(j){if(d._volume===j._volume){j._icon=i;e.UpdateTreeNode(j)}});e.UpdateTreeNode(d);a.GEO.findItemWithPainter(d,"testGeomChanges")}if((d._geoobj._typename.indexOf("TGeoNode")===0)&&a.GEO.findItemWithPainter(d)){g.add("Focus",function(){var i=a.GEO.findItemWithPainter(d);if(!i){return}var h=e.itemFullName(d,i);if(i._painter&&typeof i._painter.focusOnItem=="function"){i._painter.focusOnItem(h)}})}g.addchk(a.GEO.TestBit(c,a.GEO.BITS.kVisNone),"Invisible",a.GEO.BITS.kVisNone,f);g.addchk(a.GEO.TestBit(c,a.GEO.BITS.kVisThis),"Visible",a.GEO.BITS.kVisThis,f);g.addchk(a.GEO.TestBit(c,a.GEO.BITS.kVisDaughters),"Daughters",a.GEO.BITS.kVisDaughters,f);g.addchk(a.GEO.TestBit(c,a.GEO.BITS.kVisOneLevel),"1lvl daughters",a.GEO.BITS.kVisOneLevel,f);return true};a.GEO.findItemWithPainter=function(d,c){while(d){if(d._painter&&d._painter._camera){if(c&&typeof d._painter[c]=="function"){d._painter[c]()}return d}d=d._parent}return null};a.GEO.updateBrowserIcons=function(c,d){if(!c||!d){return}d.ForEach(function(e){if(c===e._volume){e._icon=e._icon.split(" ")[0]+a.GEO.provideVisStyle(c);d.UpdateTreeNode(e)}})};a.GEO.browserIconClick=function(c,d){if(!c._volume){return false}if(c._more&&c._volume.fNodes&&(c._volume.fNodes.arr.length>0)){a.GEO.ToggleBit(c._volume,a.GEO.BITS.kVisDaughters)}else{a.GEO.ToggleBit(c._volume,a.GEO.BITS.kVisThis)}a.GEO.updateBrowserIcons(c._volume,d);a.GEO.findItemWithPainter(c,"testGeomChanges");return false};a.GEO.getShapeIcon=function(c){switch(c._typename){case"TGeoArb8":return"img_geoarb8";break;case"TGeoCone":return"img_geocone";break;case"TGeoConeSeg":return"img_geoconeseg";break;case"TGeoCompositeShape":return"img_geocomposite";break;case"TGeoTube":return"img_geotube";break;case"TGeoTubeSeg":return"img_geotubeseg";break;case"TGeoPara":return"img_geopara";break;case"TGeoParaboloid":return"img_geoparab";break;case"TGeoPcon":return"img_geopcon";break;case"TGeoPgon":return"img_geopgon";break;case"TGeoShapeAssembly":return"img_geoassembly";break;case"TGeoSphere":return"img_geosphere";break;case"TGeoTorus":return"img_geotorus";break;case"TGeoTrd1":return"img_geotrd1";break;case"TGeoTrd2":return"img_geotrd2";break;case"TGeoXtru":return"img_geoxtru";break;case"TGeoTrap":return"img_geotrap";break;case"TGeoGtra":return"img_geogtra";break;case"TGeoEltu":return"img_geoeltu";break;case"TGeoHype":return"img_geohype";break;case"TGeoCtub":return"img_geoctub";break}return"img_geotube"};a.GEO.expandObject=function(o,k){if(!o||!k){return false}var l=(k._typename.indexOf("TGeoNode")===0),e=(k._typename.indexOf("TGeoVolume")===0),f=(k._typename==="TGeoManager"),h=(k._typename==="TEveGeoShapeExtract");if(!l&&!e&&!f&&!h){return false}if(o._childs){return true}var m,d,n;if(h){d=k.fElements?k.fElements.arr:null;n=k.fShape}else{m=f?k.fMasterVolume:(l?k.fVolume:k);d=m&&m.fNodes?m.fNodes.arr:null;n=m?m.fShape:null}if(f||(!o._geoobj&&d&&d.length&&!h)){if(f){a.GEO.createList(o,k.fMaterials,"Materials","list of materials");a.GEO.createList(o,k.fMedia,"Media","list of media");a.GEO.createList(o,k.fTracks,"Tracks","list of tracks")}if(m){a.GEO.createItem(o,m,"Volumes");a.GEO.createList(o,m.fNodes,"Nodes","Hierarchy of TGeoNodes")}return true}if(!d&&n&&(n._typename==="TGeoCompositeShape")&&n.fNode){if(!o._childs){a.GEO.createItem(o,n.fNode.fLeft,"Left");a.GEO.createItem(o,n.fNode.fRight,"Right")}return true}if(!d){return false}var c=[];for(var j=0;j<d.length;++j){if(l||h){a.GEO.createItem(o,d[j])}else{if(e){var g=d[j].fVolume;if(c.indexOf(g)<0){c.push(g);a.GEO.createItem(o,g)}}}}return true};a.addDrawFunc({name:"TGeoVolumeAssembly",icon:"img_geoassembly",func:a.Painter.drawGeoObject,expand:a.GEO.expandObject,opt:";more;all;count"});a.addDrawFunc({name:"TAxis3D",func:a.Painter.drawAxis3D});return a.Painter}));